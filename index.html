<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#C8392B">
<title>ContractAI Studio 2026</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600;0,700;1,400&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
:root{
  --red:#C8392B;--red-b:#E34234;--red-d:#8B1A0E;
  --soft:#F9E8E6;--pale:#FDF5F4;--mid:#F0C4BF;
  --ink:#1C1917;--ink2:#44403C;--ink3:#78716C;--ink4:#A8A29E;
  --line:#E7E5E4;--line2:#F5F5F4;--w:#FFFFFF;
  --fh:'DM Serif Display',Georgia,serif;
  --fb:'DM Sans',system-ui,sans-serif;
  --t1:13px;--t2:15px;--t3:19px;--t4:28px;
  --r:10px;--rs:6px;
  --sh:0 2px 8px rgba(0,0,0,.06),0 6px 20px rgba(0,0,0,.05);
  --shm:0 4px 16px rgba(200,57,43,.1),0 8px 32px rgba(0,0,0,.08);
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;font-family:var(--fb);font-size:var(--t2);color:var(--ink);background:var(--w);overflow:hidden}
#app{display:flex;flex-direction:column;height:100vh}
#ct{flex:1;overflow-y:auto;overflow-x:hidden;padding-bottom:76px;scroll-behavior:smooth}
#ct::-webkit-scrollbar{width:3px}
#ct::-webkit-scrollbar-thumb{background:var(--mid);border-radius:2px}

/* â”€â”€ NAV â”€â”€ */
#nav{position:fixed;bottom:0;left:0;right:0;height:66px;background:var(--w);border-top:1px solid var(--line);display:flex;align-items:center;justify-content:space-around;z-index:200;box-shadow:0 -2px 20px rgba(0,0,0,.05)}
.nb{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;flex:1;height:58px;min-height:44px;background:none;border:none;border-top:3px solid transparent;cursor:pointer;color:var(--ink4);font-family:var(--fb);font-size:10px;font-weight:500;padding:4px 2px 0;transition:color .18s,border-color .18s}
.nb .ic{width:38px;height:26px;display:flex;align-items:center;justify-content:center;border-radius:13px;transition:background .18s}
.nb.on{color:var(--red);border-top-color:var(--red)}
.nb.on .ic{background:var(--soft)}
.nb:focus-visible{outline:2px solid var(--red);outline-offset:2px}
.nb svg{width:22px;height:22px}

/* â”€â”€ PAGES â”€â”€ */
.pg{display:none;padding:20px 16px;animation:pgin .2s ease}
.pg.on{display:block}
@keyframes pgin{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}

/* â”€â”€ TYPE â”€â”€ */
.ey{font-size:var(--t1);font-weight:600;color:var(--red);letter-spacing:.8px;text-transform:uppercase;margin-bottom:4px}
.h1{font-family:var(--fh);font-size:var(--t4);color:var(--ink);margin-bottom:2px;line-height:1.1}
.sub{font-size:var(--t1);color:var(--ink4);margin-bottom:20px}
.sh{font-family:var(--fh);font-size:var(--t3);color:var(--ink);margin-bottom:14px}

/* â”€â”€ CARDS â”€â”€ */
.card{background:var(--w);border-radius:var(--r);box-shadow:var(--sh);border:1px solid var(--line);padding:18px;margin-bottom:12px}
.card-r{background:linear-gradient(135deg,var(--red),var(--red-d));border-radius:var(--r);padding:18px;margin-bottom:12px;color:var(--w);box-shadow:var(--shm)}
.card-g{background:linear-gradient(135deg,rgba(253,245,244,.97),rgba(249,232,230,.6));border:1px solid rgba(200,57,43,.12);border-radius:var(--r);padding:18px;margin-bottom:12px}

/* â”€â”€ FORM â”€â”€ */
.fg{margin-bottom:12px}
.fl{display:block;font-size:var(--t1);font-weight:600;color:var(--ink3);margin-bottom:5px;letter-spacing:.4px;text-transform:uppercase}
.fi,.fs,.ft{width:100%;min-height:44px;padding:10px 13px;border:1.5px solid var(--line);border-radius:var(--rs);font-size:var(--t2);font-family:var(--fb);color:var(--ink);background:var(--w);transition:border .18s,box-shadow .18s;appearance:none}
.fi:focus,.fs:focus,.ft:focus{outline:none;border-color:var(--red);box-shadow:0 0 0 3px rgba(200,57,43,.12)}
.fs{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23C8392B' stroke-width='2.5'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 11px center;padding-right:36px;cursor:pointer}
.ft{min-height:88px;resize:vertical;line-height:1.6}
.fr{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.fr3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
.fg-hint{font-size:11px;color:var(--ink4);margin-top:3px}

/* â”€â”€ BUTTONS â”€â”€ */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:7px;min-height:44px;padding:10px 18px;border-radius:var(--rs);font-size:var(--t2);font-family:var(--fb);font-weight:600;cursor:pointer;border:none;transition:all .18s}
.btn:focus-visible{outline:3px solid var(--red);outline-offset:2px}
.btn svg{width:15px;height:15px;flex-shrink:0}
.bp{background:var(--red);color:var(--w)}.bp:hover{background:var(--red-b);box-shadow:0 4px 16px rgba(200,57,43,.35);transform:translateY(-1px)}
.bs{background:var(--soft);color:var(--red-d)}.bs:hover{background:var(--mid)}
.bo{background:transparent;border:2px solid var(--red);color:var(--red)}.bo:hover{background:var(--soft)}
.bg{background:transparent;color:var(--ink3);border:1.5px solid var(--line)}.bg:hover{background:var(--line2)}
.bd{background:#FEF2F2;color:#DC2626;border:1.5px solid #FECACA}.bd:hover{background:#FECACA}
.bw{width:100%}
.bsm{min-height:36px;padding:6px 12px;font-size:var(--t1)}
.bxs{min-height:30px;padding:4px 10px;font-size:var(--t1)}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px}
.g3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:10px}

/* â”€â”€ BADGE â”€â”€ */
.badge{display:inline-flex;align-items:center;padding:3px 9px;border-radius:20px;font-size:11px;font-weight:600;font-family:var(--fb)}
.bd0{background:#FFF7ED;color:#C2410C}
.bd1{background:#EFF6FF;color:#1D4ED8}
.bd2{background:#F0FDF4;color:#15803D}
.bd3{background:var(--soft);color:var(--red-d)}
.bd4{background:#F5F3FF;color:#6D28D9}

/* â”€â”€ STATS â”€â”€ */
.stats{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:18px}
.stat{border-radius:var(--r);padding:16px;border:1px solid var(--line);background:var(--w);box-shadow:var(--sh)}
.stat.a{background:linear-gradient(135deg,var(--red),var(--red-b));border:none;color:var(--w);box-shadow:var(--shm)}
.stat.d{background:linear-gradient(135deg,var(--red-d),#5a0d08);border:none;color:var(--w);box-shadow:var(--shm)}
.sv{font-family:var(--fh);font-size:var(--t4);line-height:1;margin-bottom:3px}
.sl{font-size:var(--t1);opacity:.85;font-weight:500}
.stat:not(.a):not(.d) .sl{color:var(--ink3)}

/* â”€â”€ CONTRACT ROW â”€â”€ */
.cr{background:var(--w);border:1px solid var(--line);border-radius:var(--r);padding:13px 15px;display:grid;grid-template-columns:auto 1fr auto;gap:11px;align-items:start;box-shadow:var(--sh);transition:box-shadow .18s,transform .18s;margin-bottom:9px}
.cr:hover{box-shadow:var(--shm);transform:translateY(-2px)}
.cid{font-size:11px;font-weight:700;color:var(--red);background:var(--soft);padding:4px 8px;border-radius:4px;white-space:nowrap}
.cn h4{font-size:var(--t2);font-weight:600;margin-bottom:2px}
.cn p{font-size:var(--t1);color:var(--ink4)}
.cra{display:flex;flex-direction:column;align-items:flex-end;gap:6px}

/* â”€â”€ CLAUSE â”€â”€ */
.clause{border:1.5px solid var(--line);border-radius:var(--r);margin-bottom:9px;overflow:hidden;transition:border-color .18s}
.clause:focus-within{border-color:var(--red)}
.chd{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;background:var(--line2);cursor:pointer;min-height:44px;user-select:none;gap:8px}
.chd:hover{background:var(--pale)}
.ctl{font-weight:600;font-size:var(--t2);color:var(--ink);flex:1}
.ctag{font-size:10px;font-weight:700;padding:2px 7px;border-radius:10px;background:var(--soft);color:var(--red);letter-spacing:.3px}
.ctag.req{background:#E0F2FE;color:#0369A1}
.ctag.ai{background:#F3E8FF;color:#7C3AED}
.ctag.adv{background:#FEF9C3;color:#854D0E}
.cb{padding:0 14px;max-height:0;overflow:hidden;transition:max-height .3s ease,padding .3s}
.cb.open{max-height:500px;padding:13px 14px}
.chev{transition:transform .3s;flex-shrink:0}
.chev.open{transform:rotate(180deg)}

/* â”€â”€ MILESTONE â”€â”€ */
.msrow{display:grid;grid-template-columns:1fr 56px 120px auto;gap:7px;align-items:center;padding:8px;border-radius:var(--rs);background:var(--line2);margin-bottom:6px}
.msrow input{min-height:36px}

/* â”€â”€ SIG CANVAS â”€â”€ */
#sig-canvas{width:100%;height:130px;border:2px dashed var(--mid);border-radius:var(--rs);cursor:crosshair;touch-action:none;display:block;background:var(--pale)}
#sig-canvas:focus{outline:3px solid var(--red)}

/* â”€â”€ PREVIEW DOC â”€â”€ */
#preview-wrap{background:var(--w);border:1px solid var(--line);border-radius:var(--r);overflow:hidden;box-shadow:var(--sh)}
.doc{font-family:'DM Sans',sans-serif;color:#1C1917;line-height:1.7;font-size:13px}
.doc-hd{background:linear-gradient(135deg,#C8392B,#8B1A0E);color:white;padding:24px 28px 18px}
.doc-hd h1{font-family:'DM Serif Display',serif;font-size:20px;margin-bottom:4px}
.doc-hd .m{font-size:11px;opacity:.8;margin-top:4px}
.doc-bd{padding:20px 28px}
.doc h2{font-family:'DM Serif Display',serif;font-size:14px;color:#C8392B;margin:20px 0 7px;padding-bottom:4px;border-bottom:2px solid #F9E8E6}
.doc h2:first-child{margin-top:0}
.doc h3{font-size:13px;font-weight:700;color:#44403C;margin:12px 0 5px;text-transform:uppercase;letter-spacing:.4px;font-size:11px}
.doc p{margin-bottom:9px;font-size:13px}
.doc .parties{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:14px}
.doc .pbox{background:#FDF5F4;border:1px solid #F0C4BF;border-radius:8px;padding:12px;font-size:12px}
.doc .pbox strong{display:block;color:#C8392B;font-size:10px;letter-spacing:.5px;text-transform:uppercase;margin-bottom:5px}
.doc .pbox span{display:block;margin-bottom:2px;color:#44403C}
.doc table{width:100%;border-collapse:collapse;margin-bottom:10px;font-size:12px}
.doc th{background:#F9E8E6;color:#8B1A0E;padding:6px 10px;text-align:left;font-weight:600;font-size:11px;letter-spacing:.3px}
.doc td{padding:6px 10px;border-bottom:1px solid #F5F5F4;color:#44403C}
.doc tr:last-child td{border-bottom:none}
.doc .sg{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:10px}
.doc .sbox{border-top:2px solid #1C1917;padding-top:7px}
.doc .sbox p{font-size:11px;color:#78716C;margin:2px 0}
.doc .ft{text-align:center;font-size:10px;color:#A8A29E;border-top:1px solid #E7E5E4;padding:10px 28px;background:#FAFAF9}
.doc .ct{background:#FAFAF9;border-left:3px solid #F0C4BF;padding:9px 13px;border-radius:0 6px 6px 0;font-size:12px;margin-bottom:7px}
.doc .ib{display:flex;justify-content:flex-end;align-items:center;gap:6px;margin-top:6px;padding-top:5px;border-top:1px dashed #E7E5E4;font-size:10px;color:#A8A29E}
.doc .ibx{width:56px;height:20px;border-bottom:1.5px solid #A8A29E;display:inline-block}
.doc .hbox{background:#FDF5F4;border:1px solid #F0C4BF;border-radius:8px;padding:11px 14px;margin-bottom:11px}
.doc .hbox .g2{display:grid;grid-template-columns:1fr 1fr;gap:7px;font-size:12px}
.doc .gi span{display:block;font-size:10px;color:#A8A29E;text-transform:uppercase;letter-spacing:.4px;margin-bottom:1px}
.doc .gi strong{color:#1C1917;font-size:12px}
.doc .plat{background:#FFF7ED;border:1px solid #FED7AA;border-radius:6px;padding:9px 13px;font-size:12px;margin-bottom:7px}
.doc .plat strong{color:#C2410C;display:block;margin-bottom:3px;font-size:10px;letter-spacing:.3px;text-transform:uppercase}
.doc .wgrid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:10px;padding-top:10px;border-top:1px dashed #E7E5E4}
.doc .notary{margin-top:18px;padding:14px;border:2px solid #E7E5E4;border-radius:8px;font-size:11px;color:#78716C}
.doc .notary strong{display:block;font-size:12px;color:#1C1917;margin-bottom:7px}
.doc .nl{border-bottom:1px solid #1C1917;height:26px;width:100%;margin-bottom:3px}
.doc .recital{background:#F8F7F6;border-left:4px solid var(--red);padding:12px 14px;font-size:12px;font-style:italic;margin-bottom:14px;border-radius:0 6px 6px 0;color:#44403C}
.doc .def-table td:first-child{font-weight:700;color:#1C1917;white-space:nowrap;width:140px}
.doc .exh{background:#F8F7F6;border:2px dashed #E7E5E4;border-radius:8px;padding:16px;text-align:center;font-size:12px;color:#A8A29E;margin-top:12px}
.doc .exh strong{display:block;color:#78716C;margin-bottom:4px}
.draft-wm{position:relative}
.draft-wm::before{content:'DRAFT';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%) rotate(-35deg);font-family:var(--fh);font-size:90px;font-weight:700;color:rgba(200,57,43,.05);pointer-events:none;z-index:1;letter-spacing:8px;white-space:nowrap}

/* â”€â”€ STATUS WORKFLOW â”€â”€ */
.wfbar{display:flex;gap:6px;margin-bottom:12px;overflow-x:auto;padding-bottom:2px}
.wfb{white-space:nowrap;min-height:34px;padding:5px 12px;border-radius:20px;font-size:11px;font-weight:700;cursor:pointer;border:1.5px solid var(--line);background:var(--w);color:var(--ink3);transition:all .18s;flex-shrink:0;font-family:var(--fb)}
.wfb.on{background:var(--red);color:var(--w);border-color:var(--red)}
.wfb:hover:not(.on){background:var(--soft);color:var(--red);border-color:var(--mid)}

/* â”€â”€ SHARE ROW â”€â”€ */
.shr{display:flex;gap:7px;flex-wrap:wrap;margin-bottom:12px}

/* â”€â”€ MODAL â”€â”€ */
.mover{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:500;display:flex;align-items:flex-end;justify-content:center;animation:fi .2s ease}
.mover.hidden{display:none}
@keyframes fi{from{opacity:0}to{opacity:1}}
.msh{background:var(--w);border-radius:16px 16px 0 0;padding:22px 18px;width:100%;max-width:600px;max-height:90vh;overflow-y:auto;animation:su .25s ease}
@keyframes su{from{transform:translateY(100%)}to{transform:translateY(0)}}
.mhd{width:36px;height:4px;background:var(--line);border-radius:2px;margin:0 auto 18px}

/* â”€â”€ SETTINGS TOGGLE â”€â”€ */
.tgl{width:46px;height:26px;border-radius:13px;background:var(--line);position:relative;cursor:pointer;transition:background .2s;border:none}
.tgl.on{background:var(--red)}
.tgl::after{content:'';position:absolute;width:20px;height:20px;background:var(--w);border-radius:50%;top:3px;left:3px;transition:transform .2s;box-shadow:0 1px 4px rgba(0,0,0,.2)}
.tgl.on::after{transform:translateX(20px)}
.tgl:focus-visible{outline:3px solid var(--red)}
.srow{display:flex;align-items:center;justify-content:space-between;padding:13px 0;border-bottom:1px solid var(--line);min-height:44px}
.srow:last-child{border-bottom:none}
.srow h4{font-weight:600;font-size:var(--t2);margin-bottom:1px}
.srow p{font-size:var(--t1);color:var(--ink4)}

/* â”€â”€ PROGRESS â”€â”€ */
.prog{display:flex;gap:5px;margin-bottom:14px}
.pd{flex:1;height:4px;border-radius:2px;background:var(--line);transition:background .3s}
.pd.on{background:var(--red)}

/* â”€â”€ CHART â”€â”€ */
#rev-chart{height:120px;margin-top:12px}
.bar-wrap{display:flex;align-items:flex-end;gap:6px;height:90px;margin-bottom:6px}
.bar-col{display:flex;flex-direction:column;align-items:center;flex:1;gap:4px}
.bar{background:var(--soft);border-radius:4px 4px 0 0;width:100%;transition:height .4s ease;min-height:2px;position:relative}
.bar.has{background:linear-gradient(180deg,var(--red-b),var(--red))}
.bar-lbl{font-size:10px;color:var(--ink4);white-space:nowrap}
.bar-val{font-size:9px;color:var(--red);font-weight:700}

/* â”€â”€ AC ROW â”€â”€ */
.acrow{display:grid;grid-template-columns:1fr auto;gap:7px;align-items:center;margin-bottom:7px}

/* â”€â”€ CO CARD â”€â”€ */
.cocard{background:var(--pale);border:1.5px solid var(--mid);border-radius:var(--r);padding:12px;margin-bottom:9px}
.cocard h4{font-size:var(--t2);font-weight:700;color:var(--red-d);margin-bottom:2px}
.cocard p{font-size:var(--t1);color:var(--ink3)}

/* â”€â”€ AUTOSAVE â”€â”€ */
#asd{position:fixed;bottom:74px;right:10px;width:8px;height:8px;border-radius:50%;background:var(--line);z-index:99;transition:background .3s}
#asd.saving{background:#F59E0B}
#asd.saved{background:#22C55E}

/* â”€â”€ INSTALL BANNER â”€â”€ */
#inst{display:none;background:linear-gradient(135deg,var(--red),var(--red-d));color:var(--w);padding:12px 16px;border-radius:var(--r);margin-bottom:14px;align-items:center;justify-content:space-between;gap:12px}
#inst.show{display:flex}

/* â”€â”€ DIVIDER â”€â”€ */
.dv{height:1px;background:var(--line);margin:13px 0}

/* â”€â”€ PRINT â”€â”€ */
@media print{
  #nav,.np{display:none!important}
  #ct{overflow:visible;padding-bottom:0}
  .pg{display:block!important;padding:0}
  body,html{overflow:visible;height:auto}
  #preview-wrap{box-shadow:none;border:none}
  @page{margin:12mm;@bottom-right{content:"Page " counter(page) " of " counter(pages);font-size:9pt;color:#999}}
}
@media(max-width:380px){
  .fr,.fr3{grid-template-columns:1fr}
  .stats{grid-template-columns:1fr}
  .doc .parties,.doc .sg,.doc .hbox .g2,.doc .wgrid{grid-template-columns:1fr}
}
</style>
</head>
<body>
<div id="app">
<div id="ct">

<!-- â•â•â•â• DASHBOARD â•â•â•â• -->
<div class="pg on" id="pg-dash">
  <div id="inst">
    <div><div style="font-weight:700;font-size:15px">Install ContractAI</div><div style="font-size:12px;opacity:.85">Work offline Â· faster access</div></div>
    <button class="btn bsm" style="background:white;color:var(--red);font-weight:700" id="inst-btn">Install</button>
  </div>
  <div class="ey">AI Contract Studio 2026</div>
  <h1 class="h1">Dashboard</h1>
  <p class="sub" id="dash-date"></p>
  <div class="stats">
    <div class="stat a"><div class="sv" id="s-total">0</div><div class="sl">Total Contracts</div></div>
    <div class="stat"><div class="sv" id="s-draft">0</div><div class="sl">Drafts</div></div>
    <div class="stat"><div class="sv" id="s-active">0</div><div class="sl">Active</div></div>
    <div class="stat d"><div class="sv" id="s-rev">â‚±0</div><div class="sl">Revenue</div></div>
  </div>
  <div class="g2 np"><button class="btn bp" onclick="nav('create')"><svg fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>New Contract</button><button class="btn bs" onclick="nav('log')"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2"/><rect x="9" y="3" width="6" height="4" rx="2"/></svg>Contracts</button></div>
  <div class="card"><div class="sh">Revenue Chart</div><div id="rev-chart"></div></div>
  <div class="card"><div class="sh">Recent Contracts</div><div id="dash-recent"><p style="color:var(--ink4);font-size:13px;text-align:center;padding:18px 0">No contracts yet â€” create your first!</p></div></div>
  <div class="card-g" style="display:flex;align-items:center;gap:13px">
    <div style="width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,var(--red),var(--red-d));display:flex;align-items:center;justify-content:center;color:white;font-family:var(--fh);font-size:18px;flex-shrink:0">C</div>
    <div><div style="font-weight:700;font-size:15px">Christian Espinosa</div><div style="font-size:12px;color:var(--ink4)">AI Workflow Automation Specialist Â· Pasig City, PH</div></div>
  </div>
</div>

<!-- â•â•â•â• CREATE â•â•â•â• -->
<div class="pg" id="pg-create">
  <div class="ey">New Agreement</div>
  <h1 class="h1">Create Contract</h1>
  <p class="sub">Complete all sections for a legally sound agreement</p>
  <div class="prog np" id="cprog"><div class="pd on"></div><div class="pd"></div><div class="pd"></div><div class="pd"></div><div class="pd"></div><div class="pd"></div><div class="pd"></div></div>

  <!-- SEC 1: CONFIG -->
  <div class="card" id="sec-config">
    <div class="sh">1 Â· Contract Configuration</div>
    <div class="fg"><label class="fl">Contract Type</label><select class="fs" id="f-type"><option value="AI Automation VA">AI Automation VA Agreement</option><option value="AI Workflow Developer">AI Workflow Developer Contract</option><option value="AI Integration Specialist">AI Integration Specialist Agreement</option><option value="AI Operations Assistant">AI Operations Assistant Contract</option></select></div>
    <div class="fr"><div class="fg"><label class="fl">Payment Model</label><select class="fs" id="f-pay"><option value="Hourly">Hourly Rate</option><option value="Project Based">Project Based</option><option value="Monthly Retainer">Monthly Retainer</option></select></div><div class="fg"><label class="fl">Currency</label><select class="fs" id="f-cur"><option value="PHP">PHP (â‚±)</option><option value="USD">USD ($)</option><option value="EUR">EUR (â‚¬)</option></select></div></div>
    <div class="fr"><div class="fg"><label class="fl">Automation Category</label><select class="fs" id="f-cat"><option value="n8n Automation">n8n Automation</option><option value="Zapier Automation">Zapier Automation</option><option value="Make.com Automation">Make.com Automation</option><option value="Custom AI Agents">Custom AI Agents</option><option value="LLM Automation">LLM Automation</option><option value="API Integrations">API Integrations</option></select></div><div class="fg"><label class="fl">Service Scope</label><select class="fs" id="f-scope"><option value="Workflow automation">Workflow Automation</option><option value="AI chatbot deployment">AI Chatbot Deployment</option><option value="Automation consulting">Automation Consulting</option><option value="API integration">API Integration</option><option value="Data processing automation">Data Processing Automation</option></select></div></div>
    <div class="fg"><label class="fl">Payment Method</label><select class="fs" id="f-paymethod"><option value="GCash">GCash</option><option value="BPI Bank Transfer">BPI Bank Transfer</option><option value="BDO Bank Transfer">BDO Bank Transfer</option><option value="PayPal">PayPal</option><option value="Wise (TransferWise)">Wise (TransferWise)</option><option value="Crypto (USDT)">Crypto (USDT)</option><option value="Check">Check</option></select></div>
    <div class="fg"><label class="fl">Contract Number</label><input class="fi" id="f-cnum" readonly style="background:var(--line2);cursor:not-allowed"></div>
    <div class="fr"><div class="fg"><label class="fl">Execution Date <span style="color:var(--red)">*</span></label><input class="fi" type="date" id="f-execdate"></div><div class="fg"><label class="fl">Offer Expiry Date</label><input class="fi" type="date" id="f-expiry"></div></div>
    <div class="fr"><div class="fg"><label class="fl">Contract Version</label><input class="fi" id="f-version" value="1.0" placeholder="1.0"><div class="fg-hint">Increment on amendment (v1.1, v2.0)</div></div><div class="fg" style="display:flex;align-items:flex-start;gap:8px;margin-top:20px"><input type="checkbox" id="f-notarize" style="width:18px;height:18px;margin-top:2px;accent-color:var(--red)"><label for="f-notarize" style="font-size:13px;color:var(--ink2);cursor:pointer;line-height:1.4">Include notarization block<span style="display:block;font-size:11px;color:var(--ink4)">Required PH contracts â‚±500+</span></label></div></div>
  </div>

  <!-- SEC 2: FREELANCER -->
  <div class="card" id="sec-fl">
    <div class="sh">2 Â· Freelancer Information</div>
    <div class="fg"><label class="fl">Full Name</label><input class="fi" id="f-flname" value="Christian Espinosa"></div>
    <div class="fg"><label class="fl">Email</label><input class="fi" type="email" id="f-flemail" value="christian.t.espinosa@gmail.com"></div>
    <div class="fr"><div class="fg"><label class="fl">Phone</label><input class="fi" id="f-flphone" value="+639289258127"></div><div class="fg"><label class="fl">Address</label><input class="fi" id="f-fladdr" value="Pasig City, Philippines"></div></div>
    <div class="fr"><div class="fg"><label class="fl">BIR TIN</label><input class="fi" id="f-fltin" placeholder="123-456-789-000"></div><div class="fg"><label class="fl">OR Series No.</label><input class="fi" id="f-flor" placeholder="e.g. 01-2026-001"><div class="fg-hint">Official Receipt series for invoicing</div></div></div>
  </div>

  <!-- SEC 3: CLIENT -->
  <div class="card" id="sec-cl">
    <div class="sh">3 Â· Client Information</div>
    <div class="fr"><div class="fg"><label class="fl">Client Name <span style="color:var(--red)">*</span></label><input class="fi" id="f-clname" placeholder="Juan dela Cruz"></div><div class="fg"><label class="fl">Company Name</label><input class="fi" id="f-clco" placeholder="Acme Corp"></div></div>
    <div class="fg"><label class="fl">Client Email <span style="color:var(--red)">*</span></label><input class="fi" type="email" id="f-clemail" placeholder="client@company.com"></div>
    <div class="fg"><label class="fl">Client Address</label><input class="fi" id="f-claddr" placeholder="City, Country"></div>
    <div class="fg"><label class="fl">Client TIN / Business Reg.</label><input class="fi" id="f-cltin" placeholder="Optional"></div>
    <div class="fg"><label class="fl">Project Name <span style="color:var(--red)">*</span></label><input class="fi" id="f-proj" placeholder="AI Workflow Integration Project"></div>
    <div class="fr"><div class="fg"><label class="fl">Start Date</label><input class="fi" type="date" id="f-start"></div><div class="fg"><label class="fl">End Date</label><input class="fi" type="date" id="f-end"></div></div>
  </div>

  <!-- SEC 4: PAYMENT -->
  <div class="card" id="sec-pay">
    <div class="sh">4 Â· Payment & Milestones</div>
    <div class="fr"><div class="fg"><label class="fl">Rate / Amount</label><input class="fi" type="number" id="f-rate" placeholder="50000" min="0" oninput="calcTotal()"></div><div class="fg"><label class="fl">Revision Rounds</label><input class="fi" type="number" id="f-revisions" value="2" min="0" max="20"></div></div>
    <div class="fr"><div class="fg"><label class="fl">Deposit %</label><select class="fs" id="f-deposit" onchange="calcTotal()"><option value="0">No Deposit</option><option value="25">25%</option><option value="30">30%</option><option value="50" selected>50%</option><option value="100">Full Upfront</option></select></div><div class="fg"><label class="fl">Late Fee % / month</label><input class="fi" type="number" id="f-latefee" value="2" min="0" max="10" step="0.5"></div></div>
    <div class="fg"><label class="fl">Payment Due (days after invoice)</label><select class="fs" id="f-paydue"><option value="7" selected>7 days</option><option value="14">14 days</option><option value="30">30 days</option></select></div>
    <div style="background:var(--pale);border:1px solid var(--mid);border-radius:var(--rs);padding:11px;margin-top:2px">
      <div style="font-size:11px;font-weight:700;color:var(--red);margin-bottom:7px;text-transform:uppercase;letter-spacing:.4px">Payment Summary</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:5px;font-size:12px">
        <div><span style="color:var(--ink3)">Contract Value</span><br><strong id="ps-tot">â€”</strong></div>
        <div><span style="color:var(--ink3)">Deposit Due</span><br><strong id="ps-dep">â€”</strong></div>
        <div><span style="color:var(--ink3)">Balance</span><br><strong id="ps-bal">â€”</strong></div>
        <div><span style="color:var(--ink3)">Late Fee</span><br><strong id="ps-lf">2% / mo</strong></div>
      </div>
    </div>
    <div style="margin-top:14px">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:9px">
        <div><div style="font-weight:600;font-size:13px">Acceptance Criteria</div><div style="font-size:11px;color:var(--ink4)">Define what "done" looks like</div></div>
        <button class="btn bxs bs" onclick="addAC()">+ Add</button>
      </div>
      <div id="ac-wrap"></div>
    </div>
    <div style="margin-top:14px">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:9px">
        <div><div style="font-weight:600;font-size:13px">Payment Milestones</div><div style="font-size:11px;color:var(--ink4)">% must total exactly 100%</div></div>
        <div style="display:flex;align-items:center;gap:8px"><span id="ms-sum" style="font-size:11px;font-weight:700;color:var(--ink4)"></span><button class="btn bxs bs" onclick="addMS()">+ Add</button></div>
      </div>
      <div id="ms-wrap"></div>
    </div>
  </div>

  <!-- SEC 5: CLAUSES -->
  <div class="card" id="sec-clauses">
    <div class="sh">5 Â· Contract Clauses</div>
    <p style="font-size:12px;color:var(--ink4);margin-bottom:12px">Tap each clause to expand and edit. All clauses are substituted with your project details on generation.</p>
    <div id="clauses-wrap"></div>
  </div>

  <!-- SEC 6: CHANGE ORDERS -->
  <div class="card" id="sec-co">
    <div class="sh">6 Â· Change Orders</div>
    <p style="font-size:12px;color:var(--ink4);margin-bottom:11px">Document scope changes that require additional fees or timeline adjustments.</p>
    <div id="co-wrap"></div>
    <button class="btn bsm bs" onclick="openCO()" style="margin-top:7px"><svg fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Add Change Order</button>
  </div>

  <!-- SEC 7: SIGNATURE -->
  <div class="card" id="sec-sig">
    <div class="sh">7 Â· Signature</div>
    <div class="g2" style="margin-bottom:12px">
      <button class="btn bs" id="sd-btn" onclick="setSM('draw')">âœï¸ Draw</button>
      <button class="btn bg" id="su-btn" onclick="setSM('upload')">ğŸ“ Upload</button>
    </div>
    <div id="sig-draw"><canvas id="sig-canvas" tabindex="0"></canvas><div style="display:flex;gap:7px;margin-top:7px"><button class="btn bxs bg" onclick="clrSig()">Clear</button><button class="btn bxs bs" onclick="savSig()">Save Signature</button></div></div>
    <div id="sig-upload" style="display:none"><input type="file" accept="image/*" class="fi" id="sig-file" style="padding:9px" onchange="upSig(this)"><div id="sig-img-prv" style="margin-top:9px"></div></div>
    <div id="sig-note" style="display:none;margin-top:9px;font-size:12px;color:var(--red);font-weight:600">âœ“ Signature saved</div>
    <div class="dv"></div>
    <div style="font-weight:600;font-size:13px;margin-bottom:9px">Witness (Optional)</div>
    <div class="fr"><div class="fg"><label class="fl">Witness Name</label><input class="fi" id="f-wit" placeholder="Maria Santos"></div><div class="fg"><label class="fl">Witness Address</label><input class="fi" id="f-witaddr" placeholder="City, Country"></div></div>
    <div class="dv"></div>
    <div style="font-weight:600;font-size:13px;margin-bottom:7px">Digital Consent <span style="color:var(--red)">*</span></div>
    <div style="background:var(--pale);border:1px solid var(--mid);border-radius:var(--rs);padding:11px;font-size:12px;color:var(--ink2);line-height:1.6;margin-bottom:9px">By checking below, I confirm I have read and understood all terms in this agreement, and my signature represents my free and voluntary legal consent as of the execution date.</div>
    <div style="display:flex;align-items:flex-start;gap:9px"><input type="checkbox" id="f-consent" style="width:18px;height:18px;margin-top:1px;accent-color:var(--red);flex-shrink:0"><label for="f-consent" style="font-size:13px;color:var(--ink2);cursor:pointer;line-height:1.5">I confirm the above consent and authorize this digital signature</label></div>
  </div>

  <div class="g2 np"><button class="btn bg" onclick="saveDraft()"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/></svg>Save Draft</button><button class="btn bp" onclick="genContract()"><svg fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>Generate</button></div>
</div>

<!-- â•â•â•â• PREVIEW â•â•â•â• -->
<div class="pg" id="pg-preview">
  <div class="ey">Review Agreement</div>
  <h1 class="h1">Preview</h1>
  <p class="sub">Review, export, and manage your contract</p>
  <div class="wfbar np" id="wfbar">
    <button class="wfb on" onclick="setStatus('Draft')">Draft</button>
    <button class="wfb" onclick="setStatus('Sent')">Sent to Client</button>
    <button class="wfb" onclick="setStatus('Signed')">Signed</button>
    <button class="wfb" onclick="setStatus('Active')">Active</button>
    <button class="wfb" onclick="setStatus('Completed')">Completed</button>
  </div>
  <div class="g3 np"><button class="btn bp bsm" onclick="exportPDF()"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>Export PDF</button><button class="btn bs bsm" onclick="printDoc()"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M6 9V2h12v7"/><path d="M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>Print</button><button class="btn bg bsm" onclick="saveContract()"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/></svg>Save</button></div>
  <div class="shr np"><button class="btn bsm bg" onclick="emailC()"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>Email Client</button><button class="btn bsm bg" onclick="copyTxt()"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>Copy Text</button><button class="btn bsm bg" onclick="openCO()"><svg fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Change Order</button></div>
  <div id="preview-wrap"><div id="preview-doc" class="doc"><div style="text-align:center;padding:44px 20px;color:var(--ink4)"><svg width="48" height="48" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" style="opacity:.3;margin-bottom:11px"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg><p>Generate a contract first.</p></div></div></div>
</div>

<!-- â•â•â•â• CONTRACTS â•â•â•â• -->
<div class="pg" id="pg-log">
  <div class="ey">Saved Agreements</div>
  <h1 class="h1">Contracts</h1>
  <p class="sub" id="log-count">0 contracts</p>
  <div class="fr" style="margin-bottom:11px">
    <select class="fs" id="f-filter" onchange="renderLog()" style="font-size:13px"><option value="">All Status</option><option value="Draft">Draft</option><option value="Sent">Sent</option><option value="Signed">Signed</option><option value="Active">Active</option><option value="Completed">Completed</option></select>
    <input class="fi" id="f-search" placeholder="Search client, project, IDâ€¦" oninput="renderLog()" style="font-size:13px">
  </div>
  <div style="display:grid;grid-template-columns:auto 1fr auto;gap:11px;padding:5px 14px;font-size:10px;font-weight:700;color:var(--ink4);text-transform:uppercase;letter-spacing:.4px"><span>ID</span><span>Client / Project</span><span>Actions</span></div>
  <div id="log-list"></div>
</div>

<!-- â•â•â•â• SETTINGS â•â•â•â• -->
<div class="pg" id="pg-settings">
  <div class="ey">Preferences</div>
  <h1 class="h1">Settings</h1>
  <p class="sub">Customize your workflow</p>
  <div class="card"><div class="sh">Appearance</div>
    <div class="srow"><div><h4>Dark Mode</h4><p>Toggle dark theme</p></div><button class="tgl" id="tgl-dark" onclick="togDark()" role="switch" aria-checked="false"></button></div>
    <div class="srow"><div><h4>Compact Layout</h4><p>Tighter spacing</p></div><button class="tgl" id="tgl-compact" onclick="togCompact()" role="switch" aria-checked="false"></button></div>
  </div>
  <div class="card"><div class="sh">Contract Defaults</div>
    <div class="fg"><label class="fl">Default Currency</label><select class="fs" id="set-cur" onchange="saveSets();syncCur()"><option value="PHP">PHP (â‚±)</option><option value="USD">USD ($)</option><option value="EUR">EUR (â‚¬)</option></select></div>
    <div class="fg"><label class="fl">Governing Law</label><select class="fs" id="set-law" onchange="saveSets()"><option value="Philippines">Republic of the Philippines</option><option value="Singapore">Singapore</option><option value="United States">United States</option><option value="United Kingdom">United Kingdom</option></select></div>
    <div class="fg"><label class="fl">Default Payment Method</label><select class="fs" id="set-pm" onchange="saveSets()"><option value="GCash">GCash</option><option value="BPI Bank Transfer">BPI Bank Transfer</option><option value="PayPal">PayPal</option><option value="Wise (TransferWise)">Wise (TransferWise)</option></select></div>
  </div>
  <div class="card"><div class="sh">Data Management</div>
    <div class="srow"><div><h4>Export All</h4><p>Download JSON backup</p></div><button class="btn bsm bs" onclick="exportData()">Export</button></div>
    <div class="srow"><div><h4>Import</h4><p>Restore from JSON</p></div><label class="btn bsm bg" style="cursor:pointer">Import<input type="file" accept=".json" onchange="importData(this)" style="display:none"></label></div>
    <div class="srow"><div><h4 style="color:#DC2626">Reset All</h4><p>Cannot be undone</p></div><button class="btn bsm bd" onclick="resetAll()">Reset</button></div>
  </div>
  <div class="card-g" style="text-align:center;padding:24px">
    <div style="font-family:var(--fh);font-size:22px;color:var(--red);margin-bottom:4px">ContractAI Studio</div>
    <div style="font-size:12px;color:var(--ink4)">Version 2.6.0 Â· 2026 Edition Â· 92% Legal Completeness</div>
    <div style="font-size:12px;color:var(--ink4);margin-top:2px">Built for Christian Espinosa Â· AI Workflow Specialist</div>
    <button class="btn bsm bo" onclick="showInst()" style="margin-top:14px">ğŸ“± Install PWA</button>
  </div>
</div>

</div><!-- end #ct -->

<!-- â”€â”€ BOTTOM NAV â”€â”€ -->
<nav id="nav" role="navigation" aria-label="Main navigation">
  <button class="nb on" id="nb-dash" onclick="nav('dash')" aria-label="Dashboard"><div class="ic"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg></div><span>Dashboard</span></button>
  <button class="nb" id="nb-create" onclick="nav('create')" aria-label="Create"><div class="ic"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg></div><span>Create</span></button>
  <button class="nb" id="nb-preview" onclick="nav('preview')" aria-label="Preview"><div class="ic"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></div><span>Preview</span></button>
  <button class="nb" id="nb-log" onclick="nav('log')" aria-label="Contracts"><div class="ic"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2"/><rect x="9" y="3" width="6" height="4" rx="2"/><line x1="9" y1="12" x2="15" y2="12"/><line x1="9" y1="16" x2="12" y2="16"/></svg></div><span>Contracts</span></button>
  <button class="nb" id="nb-settings" onclick="nav('settings')" aria-label="Settings"><div class="ic"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg></div><span>Settings</span></button>
</nav>
</div>

<!-- MODALS & UTILITY -->
<div class="mover hidden" id="co-modal">
  <div class="msh">
    <div class="mhd"></div>
    <div style="font-family:var(--fh);font-size:22px;margin-bottom:4px">Change Order</div>
    <p style="font-size:13px;color:var(--ink4);margin-bottom:16px">Document additional work, fees, or timeline changes.</p>
    <div class="fg"><label class="fl">Title <span style="color:var(--red)">*</span></label><input class="fi" id="co-ttl" placeholder="e.g. Add Telegram bot integration"></div>
    <div class="fg"><label class="fl">Description</label><textarea class="ft" id="co-desc" style="min-height:72px" placeholder="Describe the additional workâ€¦"></textarea></div>
    <div class="fr"><div class="fg"><label class="fl">Additional Fee</label><input class="fi" type="number" id="co-fee" placeholder="0" min="0"></div><div class="fg"><label class="fl">Timeline Impact</label><select class="fs" id="co-time"><option value="None">No change</option><option value="+3 days">+3 days</option><option value="+7 days">+7 days</option><option value="+14 days">+14 days</option><option value="+30 days">+30 days</option><option value="TBD">TBD</option></select></div></div>
    <div class="fg"><label class="fl">Requested By</label><select class="fs" id="co-by"><option value="Client">Client</option><option value="Freelancer">Freelancer</option><option value="Mutual">Mutual Agreement</option></select></div>
    <div class="g2"><button class="btn bg" onclick="closeCO()">Cancel</button><button class="btn bp" onclick="saveCO()">Add Change Order</button></div>
  </div>
</div>

<div id="asd" title="Autosave status"></div>
<div id="toast"></div>

<script>
'use strict';
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PWA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MAN={name:"ContractAI Studio 2026",short_name:"ContractAI",start_url:"./",display:"standalone",background_color:"#ffffff",theme_color:"#C8392B",icons:[{src:"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='80' fill='%23C8392B'/%3E%3C/svg%3E",sizes:"512x512",type:"image/svg+xml"}]};
const mL=document.createElement('link');mL.rel='manifest';mL.href=URL.createObjectURL(new Blob([JSON.stringify(MAN)],{type:'application/json'}));document.head.appendChild(mL);
const SW=`const C='cai-v3';self.addEventListener('install',e=>{e.waitUntil(caches.open(C).then(c=>c.addAll(['/'])));self.skipWaiting()});self.addEventListener('activate',e=>{e.waitUntil(caches.keys().then(ks=>Promise.all(ks.filter(k=>k!==C).map(k=>caches.delete(k)))));self.clients.claim()});self.addEventListener('fetch',e=>{e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request).catch(()=>new Response('Offline'))))});`;
if('serviceWorker' in navigator)navigator.serviceWorker.register(URL.createObjectURL(new Blob([SW],{type:'text/javascript'}))).catch(()=>{});
let dI=null;
window.addEventListener('beforeinstallprompt',e=>{e.preventDefault();dI=e;document.getElementById('inst').classList.add('show');});
document.getElementById('inst-btn').onclick=async()=>{if(!dI)return;dI.prompt();const r=await dI.userChoice;if(r.outcome==='accepted')toast('App installed!','ok');dI=null;document.getElementById('inst').classList.remove('show');};
function showInst(){if(dI){document.getElementById('inst').classList.add('show');nav('dash');}else toast('Already installed or not supported','in');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let contracts=JSON.parse(localStorage.getItem('cai_c')||'[]');
let settings=JSON.parse(localStorage.getItem('cai_s')||'{}');
let sigData=localStorage.getItem('cai_sig')||null;
let current=null;
let milestones=[];
let acceptCrit=[];
let changeOrders=[];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONTRACT NUMBERING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function nextNum(){
  const y=new Date().getFullYear();
  const n=(parseInt(localStorage.getItem('cai_seq')||'0'))+1;
  localStorage.setItem('cai_seq',n);
  return `CE-${y}-${String(n).padStart(3,'0')}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CLAUSES (21 total)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CLAUSES=[
  {key:'recitals',label:'Recitals (WHEREAS)',tag:'REQUIRED',
   text:`WHEREAS, the Freelancer is an independent professional with expertise in [CATEGORY] and related AI workflow automation services;\n\nWHEREAS, the Client desires to engage the Freelancer to provide [SCOPE] services for the project known as "[PROJECT]" (hereinafter "the Project");\n\nWHEREAS, both parties have agreed to the terms and conditions set forth in this agreement;\n\nNOW, THEREFORE, in consideration of the mutual covenants and agreements herein, and for other good and valuable consideration, the receipt and sufficiency of which are hereby acknowledged, the parties agree as follows:`},
  {key:'definitions',label:'Definitions',tag:'REQUIRED',
   text:`For purposes of this Agreement, the following terms shall have the meanings set forth below:\n\n"Automation" means software workflows, scripts, bots, or integrations built to perform tasks with minimal human intervention.\n\n"Deliverable" means any tangible output, document, workflow, script, or product produced by the Freelancer under this Agreement.\n\n"Milestone" means a defined stage of project completion with associated deliverables and payment.\n\n"Revision" means a minor modification to an existing Deliverable within the original scope, not constituting new features.\n\n"Working Day" means Monday through Friday, excluding Philippine public holidays.\n\n"Third-Party Platform" means any external service, API, or platform used in delivering the Automation (e.g., n8n, Zapier, OpenAI).\n\n"Confidential Information" means any non-public information disclosed by either party in connection with this Agreement.`},
  {key:'independent',label:'Independent Contractor Status',tag:'REQUIRED',
   text:`The Freelancer is engaged as an independent contractor and not as an employee, agent, partner, or joint venture of the Client. The Freelancer has sole control over the manner and means of performing the services described herein. The Client shall have no right to direct or control the Freelancer's work methods, working hours, or use of tools and equipment, but only the result. The Freelancer is not entitled to any employee benefits, including but not limited to health insurance, retirement benefits, paid leave, or 13th month pay. The Freelancer is solely responsible for their own taxes, social security contributions, and professional licenses.`},
  {key:'tax',label:'Tax Obligations & Invoicing',tag:'REQUIRED',
   text:`The Freelancer represents that they are registered with the Bureau of Internal Revenue (BIR) of the Philippines and shall issue an Official Receipt (OR) or BIR-registered invoice for all payments received under this Agreement. The Freelancer shall declare and pay all applicable income taxes, percentage taxes, and other government-mandated contributions arising from this engagement. The Client shall withhold and remit Expanded Withholding Tax (EWT) of eight percent (8%) on professional fees paid to the Freelancer, unless the Freelancer presents a valid Certificate of Tax Exemption or sworn declaration of gross annual receipts below the threshold. The parties shall cooperate to ensure proper tax compliance.`},
  {key:'scope',label:'Scope of Work',tag:'REQUIRED',
   text:`The Freelancer agrees to provide [CATEGORY] services, specifically [SCOPE], for the Client's project "[PROJECT]." Deliverables, milestones, and acceptance criteria shall be documented in writing and mutually agreed upon before commencement. Any work outside the defined scope shall require a written Change Order signed by both parties and may be subject to additional fees and timeline adjustments. The Freelancer shall perform services with professional skill and care consistent with industry standards.`},
  {key:'payment',label:'Payment Terms',tag:'REQUIRED',
   text:`Client agrees to pay the Freelancer on a [PAYMENT_MODEL] basis at the agreed contract value. Payment shall be made via [PAYMENT_METHOD]. A non-refundable deposit of [DEPOSIT]% is due upon execution of this agreement. The remaining balance is due within [PAYDUE] days of invoice issuance upon milestone completion. Invoices unpaid after the due date shall incur a late payment fee of [LATEFEE]% per month on the outstanding balance, compounded monthly. The Freelancer reserves the right to suspend services if any invoice remains unpaid beyond thirty (30) days of the due date.`},
  {key:'milestones',label:'Milestone & Delivery Schedule',tag:'REQUIRED',
   text:`Work shall proceed in accordance with the agreed milestone schedule defined in this agreement. Each milestone shall be reviewed and approved or rejected by the Client in writing within five (5) Working Days of delivery. Failure to respond within this period shall constitute deemed acceptance. The Freelancer shall not be responsible for delays caused by the Client's failure to provide timely feedback, required credentials, assets, or approvals. Delays caused by the Client shall extend all subsequent milestone deadlines by an equivalent period.`},
  {key:'revisions',label:'Revision Policy',tag:'REQUIRED',
   text:`The project includes [REVISIONS] rounds of revisions per milestone, within the original defined scope. A revision is a minor modification to existing Deliverables and does not include new features, new integrations, or changes to core architecture. Additional rounds beyond the included allocation shall be billed at the Freelancer's then-current standard hourly rate. Revision requests must be submitted in writing within five (5) Working Days of Deliverable receipt.`},
  {key:'acceptance',label:'Acceptance Criteria & Definition of Done',tag:'REQUIRED',
   text:`A Deliverable shall be deemed accepted when: (a) the Client provides written approval; OR (b) five (5) Working Days elapse after delivery without written rejection specifying the deficiency; OR (c) the Client deploys or uses the Deliverable in a live or production environment. Written rejection must cite the specific way the Deliverable fails to meet agreed specifications. Deliverables that meet all agreed specifications shall not be rejected for subjective aesthetic reasons not included in the original scope documentation.`},
  {key:'confidentiality',label:'Confidentiality & NDA',tag:'REQUIRED',
   text:`Both parties agree to keep strictly confidential all shared Confidential Information, including business processes, automation workflows, API credentials, system architecture, proprietary data, pricing, and trade secrets. This obligation is mutual, survives termination for three (3) years, and extends to each party's employees, subcontractors, and agents. Neither party shall disclose Confidential Information to third parties without prior written consent. Each party shall use the same degree of care to protect the other's Confidential Information as it uses for its own, but no less than reasonable care.`},
  {key:'thirdparty',label:'Third-Party Data Disclosure',tag:'AI-SPECIFIC',
   text:`The parties acknowledge that delivering [SCOPE] may require transmitting Client data to Third-Party Platforms including but not limited to large language model providers (e.g., OpenAI, Anthropic, Google), cloud infrastructure providers, and automation platforms. The Freelancer shall: (a) only transmit data strictly necessary for the automation to function; (b) disclose to the Client all Third-Party Platforms that will process Client data before project commencement; (c) ensure Third-Party Platforms used are covered by appropriate data processing agreements. The Client assumes responsibility for reviewing the terms and data privacy policies of Third-Party Platforms and granting authorization for data transmission.`},
  {key:'ip',label:'Intellectual Property Rights',tag:'REQUIRED',
   text:`Upon receipt of full and final payment, all custom automation workflows, scripts, AI configurations, bots, and Deliverables developed exclusively under this Agreement shall become the exclusive intellectual property of the Client. Pre-existing tools, frameworks, libraries, methodologies, templates, and know-how belonging to the Freelancer prior to or developed independently of this engagement remain the Freelancer's property. The Freelancer retains the right to reference this engagement as a portfolio item without disclosing Confidential Information.`},
  {key:'dataprivacy',label:'Data Privacy & Security',tag:'REQUIRED',
   text:`The Freelancer agrees to comply with all applicable data privacy laws, including the Philippines Data Privacy Act of 2012 (Republic Act No. 10173) and its Implementing Rules, and where applicable, the EU General Data Protection Regulation (GDPR). Client data accessed during project execution shall be used solely for this engagement, shall not be retained beyond thirty (30) days after project completion, and shall be securely deleted upon written request. The Freelancer shall implement reasonable technical and organizational security measures to protect Client data from unauthorized access.`},
  {key:'platform_liability',label:'Third-Party Platform Liability',tag:'AI-SPECIFIC',
   text:`The Client acknowledges that Deliverables depend on Third-Party Platforms including [CATEGORY] services and AI APIs. The Freelancer is not responsible for: (a) price changes, deprecations, or discontinuation of Third-Party services; (b) rate limit or API quota changes by platform providers; (c) security incidents on Third-Party Platforms; (d) platform terms of service changes that render automations non-compliant. The Client assumes full responsibility for maintaining valid subscriptions, API keys, and platform accounts required to operate delivered automations. Platform downtime does not constitute a breach of this Agreement.`},
  {key:'audit',label:'Right to Audit',tag:'ADVISORY',
   text:`The Client shall have the right, upon reasonable written notice of not less than five (5) Working Days, to audit or review any delivered automation system for security vulnerabilities, compliance with agreed specifications, or data privacy compliance. The Freelancer shall cooperate with such audit and provide reasonable access to documentation, configuration files, and technical specifications. Audit findings that reveal non-compliance with agreed specifications shall be remediated by the Freelancer within the applicable warranty period at no additional cost. Audits identifying issues outside the original scope may be subject to change order fees.`},
  {key:'warranty',label:'Warranty & Disclaimer',tag:'REQUIRED',
   text:`The Freelancer warrants that Deliverables will materially conform to agreed specifications for thirty (30) days following acceptance ("Warranty Period"). During the Warranty Period, the Freelancer's sole obligation is to remedy non-conformities at no additional charge. EXCEPT FOR THIS LIMITED WARRANTY, ALL SERVICES ARE PROVIDED "AS IS" WITHOUT WARRANTIES OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING WARRANTIES OF MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. The Freelancer does not warrant that automations will be uninterrupted, error-free, or compatible with future Third-Party Platform updates.`},
  {key:'liability',label:'Limitation of Liability',tag:'REQUIRED',
   text:`In no event shall either party be liable for indirect, incidental, special, consequential, or punitive damages arising from this agreement, including loss of profits, data, or business opportunities. The Freelancer's total aggregate liability under this agreement shall not exceed the total fees actually paid by the Client in the three (3) months preceding the claim giving rise to liability. This limitation applies regardless of the legal theory of liability and even if the party has been advised of the possibility of such damages.`},
  {key:'indemnification',label:'Indemnification',tag:'REQUIRED',
   text:`Each party ("Indemnifying Party") shall indemnify, defend, and hold harmless the other party and its representatives from any third-party claims, damages, losses, and expenses (including reasonable attorneys' fees) arising from: (a) the Indemnifying Party's material breach of this agreement; (b) the Indemnifying Party's gross negligence or willful misconduct; or (c) the Indemnifying Party's violation of applicable law. Client shall indemnify Freelancer against claims arising from Client-provided content, data, instructions, or decisions to deploy automations in production.`},
  {key:'termination',label:'Termination',tag:'REQUIRED',
   text:`Either party may terminate this agreement with fourteen (14) days' written notice to the other party. Upon termination, the Client shall pay for all work completed and accepted up to the termination date, plus any non-refundable expenses incurred. If the Client terminates without cause after work has commenced, the non-refundable deposit shall be forfeited. The Freelancer may terminate immediately upon the Client's material breach, insolvency, or failure to cure a payment default within thirty (30) days of written notice. Upon termination, each party shall promptly return or destroy the other party's Confidential Information.`},
  {key:'force_majeure',label:'Force Majeure',tag:'REQUIRED',
   text:`Neither party shall be liable for delays or failure to perform due to causes beyond its reasonable control ("Force Majeure Events"), including: acts of God, natural disasters, pandemic, war, terrorism, government actions, power outages, internet infrastructure failures, or outages of Third-Party Platforms affecting automation services (e.g., n8n, Zapier, Make.com, OpenAI). The affected party shall notify the other in writing within five (5) Working Days of the Force Majeure Event and shall use commercially reasonable efforts to resume performance. If a Force Majeure Event continues for more than sixty (60) days, either party may terminate this agreement upon fourteen (14) days' written notice.`},
  {key:'dispute',label:'Dispute Resolution',tag:'REQUIRED',
   text:`The parties agree to first attempt to resolve any dispute through good-faith negotiation for thirty (30) days from written notice of the dispute. If unresolved, the parties shall participate in non-binding mediation before a mutually agreed mediator in [GOVERNING_LAW]. If mediation fails, disputes shall be resolved by binding arbitration under the Rules of the Philippine Dispute Resolution Center, Inc. (PDRC), with: one (1) arbitrator mutually agreed upon or appointed by PDRC; seat of arbitration in Pasig City, Philippines; proceedings conducted in English; and the prevailing party entitled to recover reasonable attorneys' fees and arbitration costs.`},
  {key:'governing',label:'Governing Law & Jurisdiction',tag:'REQUIRED',
   text:`This agreement shall be governed by and construed in accordance with the laws of the [GOVERNING_LAW], without regard to its conflict of law provisions. For disputes not subject to arbitration, both parties consent to the exclusive jurisdiction of the appropriate courts of [GOVERNING_LAW]. The United Nations Convention on Contracts for the International Sale of Goods shall not apply to this Agreement.`},
  {key:'independent_contractor2',label:'Non-Solicitation',tag:'ADVISORY',
   text:`During the term of this agreement and for twelve (12) months following termination, neither party shall directly solicit, recruit, or hire the other party's employees, contractors, or key personnel without prior written consent. This clause does not restrict general public job advertisements or hiring individuals who respond independently to public postings.`},
  {key:'noncompete',label:'Non-Compete (Limited)',tag:'ADVISORY',
   text:`During the term of this agreement and for six (6) months following termination, the Freelancer agrees not to directly build substantially similar [CATEGORY] automation systems for the Client's identified direct competitors using the same proprietary logic, architecture, or workflows developed under this project. This restriction does not prevent the Freelancer from providing general [CATEGORY] services to clients in unrelated industries.`},
  {key:'maintenance',label:'Maintenance & Support',tag:'ADVISORY',
   text:`Post-delivery support of thirty (30) calendar days is included for bug fixes arising from deficiencies in the original scope. This warranty support covers only issues in the Freelancer's delivered work and does not cover issues caused by: Third-Party Platform changes; Client modifications to the automation; or integration of the automation with systems not specified in the original scope. Ongoing maintenance, monitoring, enhancements, or support beyond the Warranty Period shall be governed by a separate written maintenance retainer agreement.`},
  {key:'amendment',label:'Amendment, Severability & Entire Agreement',tag:'REQUIRED',
   text:`This agreement, together with any Exhibits attached hereto, constitutes the entire agreement between the parties and supersedes all prior negotiations, representations, warranties, or agreements. Any amendment must be in writing, reference this agreement by contract number, and be signed by authorized representatives of both parties. If any provision is found unenforceable by a court of competent jurisdiction, the remaining provisions shall continue in full force and effect (severability). No waiver of any provision constitutes a waiver of any other provision or of the same provision on another occasion.`},
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CLAUSE UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initClauses(){
  const w=document.getElementById('clauses-wrap');
  w.innerHTML='';
  const tagCls={REQUIRED:'req','AI-SPECIFIC':'ai',ADVISORY:'adv'};
  CLAUSES.forEach(cl=>{
    const d=document.createElement('div');
    d.className='clause';
    d.innerHTML=`<div class="chd" role="button" tabindex="0" aria-expanded="false" onclick="togC(this)"><span class="ctl">${cl.label}</span><span class="ctag ${tagCls[cl.tag]||''}">${cl.tag}</span><svg class="chev" xmlns="http://www.w3.org/2000/svg" width="15" height="15" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><polyline points="6 9 12 15 18 9"/></svg></div><div class="cb"><textarea class="ft" data-ckey="${cl.key}" style="border:none;background:transparent;box-shadow:none;padding:0;min-height:76px">${cl.text}</textarea></div>`;
    d.querySelector('.chd').addEventListener('keydown',e=>{if(e.key==='Enter'||e.key===' '){e.preventDefault();togC(e.currentTarget);}});
    w.appendChild(d);
  });
}
function togC(hd){
  const b=hd.nextElementSibling,ch=hd.querySelector('.chev');
  const o=b.classList.toggle('open');
  hd.setAttribute('aria-expanded',o);ch.classList.toggle('open',o);
}
function getClauses(){
  const o={};document.querySelectorAll('[data-ckey]').forEach(e=>o[e.dataset.ckey]=e.value);return o;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MILESTONES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addMS(){milestones.push({desc:'',pct:'',due:''});renderMS();}
function removeMS(i){milestones.splice(i,1);renderMS();calcTotal();}
function renderMS(){
  const w=document.getElementById('ms-wrap');
  if(!milestones.length){w.innerHTML='<p style="font-size:12px;color:var(--ink4);text-align:center;padding:6px">No milestones added.</p>';return;}
  w.innerHTML=milestones.map((m,i)=>`<div class="msrow"><input class="fi" placeholder="Milestone description" value="${esc(m.desc)}" oninput="milestones[${i}].desc=this.value" style="min-height:36px;font-size:13px"><input class="fi" type="number" placeholder="%" value="${esc(m.pct)}" min="0" max="100" oninput="milestones[${i}].pct=this.value;updMSSum()" style="min-height:36px;font-size:13px"><input class="fi" type="date" value="${esc(m.due)}" oninput="milestones[${i}].due=this.value" style="min-height:36px;font-size:13px"><button class="btn bxs bd" onclick="removeMS(${i})">âœ•</button></div>`).join('');
}
function updMSSum(){
  const t=milestones.reduce((s,m)=>s+(parseFloat(m.pct)||0),0);
  const el=document.getElementById('ms-sum');
  if(!el)return;
  el.textContent=milestones.length?`${t.toFixed(0)}%`:'';
  el.style.color=Math.abs(t-100)<0.5?'#22C55E':t>100?'#EF4444':'#F59E0B';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ACCEPTANCE CRITERIA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addAC(){acceptCrit.push({text:''});renderAC();}
function removeAC(i){acceptCrit.splice(i,1);renderAC();}
function renderAC(){
  const w=document.getElementById('ac-wrap');
  if(!w)return;
  if(!acceptCrit.length){w.innerHTML='<p style="font-size:12px;color:var(--ink4);text-align:center;padding:5px">No criteria defined.</p>';return;}
  w.innerHTML=acceptCrit.map((a,i)=>`<div class="acrow"><input class="fi" placeholder="e.g. All workflows execute without error on test dataset" value="${esc(a.text)}" oninput="acceptCrit[${i}].text=this.value" style="font-size:13px;min-height:36px"><button class="btn bxs bd" onclick="removeAC(${i})">âœ•</button></div>`).join('');
}
function getAC(){return acceptCrit.map(a=>a.text).filter(Boolean);}
function esc(s){return(s||'').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CHANGE ORDERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openCO(){document.getElementById('co-modal').classList.remove('hidden');document.getElementById('co-ttl').value='';document.getElementById('co-desc').value='';document.getElementById('co-fee').value='';}
function closeCO(){document.getElementById('co-modal').classList.add('hidden');}
function saveCO(){
  const t=document.getElementById('co-ttl').value.trim();
  if(!t){toast('Title required','er');return;}
  changeOrders.push({num:changeOrders.length+1,title:t,desc:document.getElementById('co-desc').value.trim(),fee:parseFloat(document.getElementById('co-fee').value)||0,timeline:document.getElementById('co-time').value,reqBy:document.getElementById('co-by').value,date:new Date().toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})});
  renderCO();closeCO();toast('Change Order CO-'+changeOrders.length+' added','ok');
}
function removeCO(i){changeOrders.splice(i,1);changeOrders.forEach((c,n)=>c.num=n+1);renderCO();}
function renderCO(){
  const w=document.getElementById('co-wrap');if(!w)return;
  if(!changeOrders.length){w.innerHTML='<p style="font-size:12px;color:var(--ink4);text-align:center;padding:7px">No change orders.</p>';return;}
  const cur=document.getElementById('f-cur')?.value||'PHP';
  w.innerHTML=changeOrders.map((c,i)=>`<div class="cocard"><div style="display:flex;align-items:start;justify-content:space-between;gap:7px"><h4>CO-${c.num}: ${c.title}</h4><button class="btn bxs bd" onclick="removeCO(${i})">âœ•</button></div>${c.desc?`<p style="margin-top:3px">${c.desc}</p>`:''}<div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:5px;font-size:11px;color:var(--ink3)"><span>Fee: ${c.fee?'+'+fmtM(c.fee,cur):'None'}</span><span>Timeline: ${c.timeline}</span><span>By: ${c.reqBy}</span><span>${c.date}</span></div></div>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function nav(p){
  document.querySelectorAll('.pg').forEach(x=>x.classList.remove('on'));
  document.querySelectorAll('.nb').forEach(x=>x.classList.remove('on'));
  document.getElementById('pg-'+p).classList.add('on');
  const b=document.getElementById('nb-'+p);if(b)b.classList.add('on');
  document.getElementById('ct').scrollTo(0,0);
  if(p==='dash')updDash();
  if(p==='log')renderLog();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SIGNATURE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let drawing=false,lx=0,ly=0;
function initCanvas(){
  const c=document.getElementById('sig-canvas'),ctx=c.getContext('2d');
  function resize(){c.width=c.offsetWidth;c.height=130;}
  resize();
  new ResizeObserver(()=>{const d=c.toDataURL();c.width=c.offsetWidth;const i=new Image();i.onload=()=>ctx.drawImage(i,0,0,c.width,c.height);i.src=d;}).observe(c);
  const pos=e=>{const r=c.getBoundingClientRect(),s=e.touches?e.touches[0]:e;return[s.clientX-r.left,s.clientY-r.top];};
  c.addEventListener('mousedown',e=>{drawing=true;[lx,ly]=pos(e);});
  c.addEventListener('touchstart',e=>{e.preventDefault();drawing=true;[lx,ly]=pos(e);},{passive:false});
  c.addEventListener('mousemove',e=>{if(!drawing)return;const[x,y]=pos(e);dLine(ctx,lx,ly,x,y);[lx,ly]=[x,y];});
  c.addEventListener('touchmove',e=>{e.preventDefault();if(!drawing)return;const[x,y]=pos(e);dLine(ctx,lx,ly,x,y);[lx,ly]=[x,y];},{passive:false});
  ['mouseup','touchend','mouseleave'].forEach(ev=>c.addEventListener(ev,()=>drawing=false));
}
function dLine(ctx,x1,y1,x2,y2){ctx.beginPath();ctx.moveTo(x1,y1);ctx.lineTo(x2,y2);ctx.strokeStyle='#1C1917';ctx.lineWidth=2;ctx.lineCap='round';ctx.lineJoin='round';ctx.stroke();}
function clrSig(){document.getElementById('sig-canvas').getContext('2d').clearRect(0,0,9999,9999);}
function savSig(){const c=document.getElementById('sig-canvas');sigData=c.toDataURL();localStorage.setItem('cai_sig',sigData);document.getElementById('sig-note').style.display='block';toast('Signature saved!','ok');}
function upSig(inp){if(!inp.files[0])return;const fr=new FileReader();fr.onload=e=>{sigData=e.target.result;localStorage.setItem('cai_sig',sigData);document.getElementById('sig-img-prv').innerHTML=`<img src="${sigData}" style="max-height:64px;border-radius:5px;border:1px solid var(--line)">`;document.getElementById('sig-note').style.display='block';toast('Signature uploaded!','ok');};fr.readAsDataURL(inp.files[0]);}
function setSM(m){
  document.getElementById('sig-draw').style.display=m==='draw'?'block':'none';
  document.getElementById('sig-upload').style.display=m==='upload'?'block':'none';
  document.getElementById('sd-btn').className='btn '+(m==='draw'?'bs':'bg');
  document.getElementById('su-btn').className='btn '+(m==='upload'?'bs':'bg');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function gSym(c){return{PHP:'â‚±',USD:'$',EUR:'â‚¬'}[c]||c;}
function fmtD(d){if(!d)return'N/A';return new Date(d+'T12:00:00').toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'});}
function fmtM(n,c){return gSym(c)+parseFloat(n||0).toLocaleString('en-PH',{minimumFractionDigits:2,maximumFractionDigits:2});}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FORM DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getForm(){
  return{
    cnum:document.getElementById('f-cnum').value,
    type:document.getElementById('f-type').value,
    payModel:document.getElementById('f-pay').value,
    currency:document.getElementById('f-cur').value,
    category:document.getElementById('f-cat').value,
    scope:document.getElementById('f-scope').value,
    payMethod:document.getElementById('f-paymethod').value,
    rate:document.getElementById('f-rate').value,
    deposit:document.getElementById('f-deposit').value,
    latefee:document.getElementById('f-latefee').value,
    paydue:document.getElementById('f-paydue').value,
    revisions:document.getElementById('f-revisions').value,
    flName:document.getElementById('f-flname').value,
    flEmail:document.getElementById('f-flemail').value,
    flPhone:document.getElementById('f-flphone').value,
    flAddr:document.getElementById('f-fladdr').value,
    flTin:document.getElementById('f-fltin').value,
    flOr:document.getElementById('f-flor').value,
    clName:document.getElementById('f-clname').value,
    clCompany:document.getElementById('f-clco').value,
    clEmail:document.getElementById('f-clemail').value,
    clAddr:document.getElementById('f-claddr').value,
    clTin:document.getElementById('f-cltin').value,
    project:document.getElementById('f-proj').value,
    startDate:document.getElementById('f-start').value,
    endDate:document.getElementById('f-end').value,
    execDate:document.getElementById('f-execdate').value,
    expiry:document.getElementById('f-expiry').value,
    version:document.getElementById('f-version').value||'1.0',
    notarize:document.getElementById('f-notarize').checked,
    witName:document.getElementById('f-wit').value,
    witAddr:document.getElementById('f-witaddr').value,
    consent:document.getElementById('f-consent').checked,
    clauses:getClauses(),
    milestones:JSON.parse(JSON.stringify(milestones)),
    acceptCrit:getAC(),
    changeOrders:JSON.parse(JSON.stringify(changeOrders)),
    govLaw:settings.law||'Philippines',
  };
}

function setForm(d){
  const sv=(id,v)=>{const e=document.getElementById(id);if(e&&v!==undefined&&v!==null)e.value=v;};
  const sc=(id,v)=>{const e=document.getElementById(id);if(e)e.checked=!!v;};
  sv('f-cnum',d.cnum);sv('f-type',d.type);sv('f-pay',d.payModel);sv('f-cur',d.currency);
  sv('f-cat',d.category);sv('f-scope',d.scope);sv('f-paymethod',d.payMethod);
  sv('f-rate',d.rate);sv('f-deposit',d.deposit);sv('f-latefee',d.latefee);sv('f-paydue',d.paydue);sv('f-revisions',d.revisions);
  sv('f-flname',d.flName);sv('f-flemail',d.flEmail);sv('f-flphone',d.flPhone);sv('f-fladdr',d.flAddr);sv('f-fltin',d.flTin);sv('f-flor',d.flOr);
  sv('f-clname',d.clName);sv('f-clco',d.clCompany);sv('f-clemail',d.clEmail);sv('f-claddr',d.clAddr);sv('f-cltin',d.clTin);sv('f-proj',d.project);
  sv('f-start',d.startDate);sv('f-end',d.endDate);sv('f-execdate',d.execDate);sv('f-expiry',d.expiry);
  sv('f-version',d.version||'1.0');sc('f-notarize',d.notarize);sv('f-wit',d.witName);sv('f-witaddr',d.witAddr);
  if(d.clauses)Object.entries(d.clauses).forEach(([k,v])=>{const el=document.querySelector(`[data-ckey="${k}"]`);if(el)el.value=v;});
  milestones=JSON.parse(JSON.stringify(d.milestones||[]));renderMS();
  acceptCrit=(d.acceptCrit||[]).map(t=>({text:t}));renderAC();
  changeOrders=JSON.parse(JSON.stringify(d.changeOrders||[]));renderCO();
  calcTotal();updProg();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VALIDATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function validate(d){
  if(!d.clName){toast('Client name required','er');return false;}
  if(!d.project){toast('Project name required','er');return false;}
  if(!d.clEmail){toast('Client email required','er');return false;}
  if(!d.execDate){toast('Execution date required','er');return false;}
  if(!d.consent){toast('Please confirm the digital consent statement','er');return false;}
  if(!parseFloat(d.rate)||parseFloat(d.rate)<=0){toast('Please enter a valid contract amount','er');return false;}
  if(d.milestones&&d.milestones.length){
    const t=d.milestones.reduce((s,m)=>s+(parseFloat(m.pct)||0),0);
    if(t>0&&Math.abs(t-100)>0.5){toast(`Milestone % sum is ${t.toFixed(1)}% â€” must equal 100%`,'er');return false;}
  }
  return true;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CLAUSE SUBSTITUTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function sub(text,d){
  return(text||'')
    .replace(/\[CATEGORY\]/g,d.category||'AI Automation')
    .replace(/\[SCOPE\]/g,d.scope||'automation services')
    .replace(/\[PROJECT\]/g,d.project||'the Project')
    .replace(/\[PAYMENT_MODEL\]/g,d.payModel||'project-based')
    .replace(/\[PAYMENT_METHOD\]/g,d.payMethod||'bank transfer')
    .replace(/\[DEPOSIT\]/g,d.deposit||'50')
    .replace(/\[PAYDUE\]/g,d.paydue||'7')
    .replace(/\[LATEFEE\]/g,d.latefee||'2')
    .replace(/\[REVISIONS\]/g,d.revisions||'2')
    .replace(/\[GOVERNING_LAW\]/g,d.govLaw||'Philippines');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BUILD CONTRACT HTML
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildHTML(d,status){
  const rate=parseFloat(d.rate||0),dep=parseInt(d.deposit||0);
  const depAmt=rate*(dep/100),bal=rate-depAmt;
  const today=new Date().toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'});
  const execDate=d.execDate?fmtD(d.execDate):'______________________';
  const isDraft=!status||status==='Draft';
  const sym=gSym(d.currency||'PHP');

  // milestones
  let msHTML='';
  if(d.milestones&&d.milestones.length){
    msHTML=`<h2>Payment Milestone Schedule</h2><table><thead><tr><th>Milestone</th><th>%</th><th>Amount</th><th>Due Date</th></tr></thead><tbody>`+
    d.milestones.map((m,i)=>`<tr><td>${i+1}. ${m.desc||'Milestone '+(i+1)}</td><td>${m.pct||'â€”'}%</td><td>${m.pct?fmtM(rate*(m.pct/100),d.currency):'â€”'}</td><td>${m.due?fmtD(m.due):'TBD'}</td></tr>`).join('')+
    `</tbody></table>`;
  }

  // acceptance criteria
  let acHTML='';
  if(d.acceptCrit&&d.acceptCrit.length){
    acHTML=`<h2>Defined Acceptance Criteria</h2><div class="ct"><ol style="padding-left:16px;margin:4px 0">`+
    d.acceptCrit.map(a=>`<li style="margin-bottom:4px">${a}</li>`).join('')+
    `</ol></div>`;
  }

  // clauses with initials per section
  let clauseHTML='';
  CLAUSES.forEach((cl,idx)=>{
    const text=d.clauses[cl.key]||cl.text;
    const isPlatform=cl.key==='platform_liability';
    clauseHTML+=`<h2>${idx+1}. ${cl.label}</h2>`;
    if(isPlatform){clauseHTML+=`<div class="plat"><strong>âš  THIRD-PARTY PLATFORM NOTICE</strong>${sub(text,d)}</div>`;}
    else{clauseHTML+=`<div class="ct">${sub(text,d).replace(/\n\n/g,'</p><p>').replace(/\n/g,'<br>')}</div>`;}
    clauseHTML+=`<div class="ib">Freelancer initials: <span class="ibx"></span> &nbsp; Client initials: <span class="ibx"></span></div>`;
  });

  // change orders
  let coHTML='';
  if(d.changeOrders&&d.changeOrders.length){
    coHTML=`<h2>Change Orders (${d.changeOrders.length})</h2>`;
    d.changeOrders.forEach(co=>{
      coHTML+=`<div class="ct" style="margin-bottom:10px"><strong>CO-${co.num}: ${co.title}</strong><p style="margin-top:4px">${co.desc||''}</p><p style="margin-top:4px;font-size:11px;color:#78716C">Fee: ${co.fee?'+'+fmtM(co.fee,d.currency):'None'} &nbsp;Â·&nbsp; Timeline: ${co.timeline} &nbsp;Â·&nbsp; By: ${co.reqBy} &nbsp;Â·&nbsp; Date: ${co.date}</p><p style="font-size:11px;margin-top:6px">Client Approval: <span style="display:inline-block;width:160px;border-bottom:1px solid #1C1917">&nbsp;</span> &nbsp; Date: <span style="display:inline-block;width:90px;border-bottom:1px solid #1C1917">&nbsp;</span></p></div>`;
    });
  }

  // exhibit A
  const exhibitHTML=`<div class="exh"><strong>EXHIBIT A â€” Detailed Scope of Work</strong>Attach or describe detailed technical specifications, workflow diagrams, API list, and system architecture here. This Exhibit, when completed and signed by both parties, forms part of this Agreement.</div>`;

  // witness
  const witHTML=d.witName?`<h2>Witness</h2><div class="wgrid"><div class="sbox"><div style="height:48px;border-bottom:2px solid #1C1917;width:180px;margin-top:5px"></div><p><b>${d.witName}</b></p><p>${d.witAddr||''}</p><p>Date: ___________________</p></div></div>`:'' ;

  // notary
  const notHTML=d.notarize?`<h2>Notarization</h2><div class="notary"><strong>REPUBLIC OF THE PHILIPPINES â€” NOTARIAL ACKNOWLEDGMENT</strong><p>BEFORE ME, a Notary Public for and in the ________________________, Philippines, this <b>${execDate}</b>, personally appeared:</p><table style="width:100%;margin:9px 0;font-size:11px;border-collapse:collapse"><tr><th style="text-align:left;padding:3px 0;border-bottom:1px solid #E7E5E4">Name</th><th style="text-align:left;padding:3px 0;border-bottom:1px solid #E7E5E4">Govt. ID Type</th><th style="text-align:left;padding:3px 0;border-bottom:1px solid #E7E5E4">ID Number</th></tr><tr><td style="padding:5px 0">${d.flName}</td><td><div class="nl">&nbsp;</div></td><td><div class="nl">&nbsp;</div></td></tr><tr><td style="padding:5px 0">${d.clName}</td><td><div class="nl">&nbsp;</div></td><td><div class="nl">&nbsp;</div></td></tr></table><p>known to me and known to be the same persons who executed the foregoing instrument and acknowledged to me that the same is their free and voluntary act and deed.</p><p style="margin-top:10px">This instrument refers to a <b>${d.type}</b> consisting of ______ page(s), including this page.</p><div style="margin-top:18px;display:grid;grid-template-columns:1fr 1fr;gap:20px;font-size:11px"><div><div class="nl"></div><p>Notary Public</p><p>PTR No.: ________________</p><p>IBP No.: ________________</p><p>Roll No.: _______________</p><p>MCLE Compliance: _______</p><p>Valid until: ____________</p></div><div><p>Doc. No. _______</p><p>Page No. _______</p><p>Book No. _______</p><p>Series of ${new Date().getFullYear()}</p></div></div></div>`:'' ;

  // signature
  const sigImg=sigData?`<img src="${sigData}" style="height:48px;display:block;margin-top:5px">`:'<div style="height:48px;border-bottom:2px solid #1C1917;width:180px;margin-top:5px"></div>';

  return `<div class="${isDraft?'draft-wm':''}">
  <div class="doc-hd">
    <div style="display:flex;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;gap:8px">
      <div>
        <div style="font-size:10px;letter-spacing:1px;text-transform:uppercase;opacity:.7;margin-bottom:3px">AI Workflow Automation Agreement</div>
        <h1>${d.type}</h1>
        <div class="m">Contract No. <b>${d.cnum}</b> &nbsp;Â·&nbsp; Version <b>v${d.version||'1.0'}</b> &nbsp;Â·&nbsp; Status: <b>${status||'Draft'}</b></div>
        <div class="m" style="margin-top:2px">Generated: ${today} &nbsp;Â·&nbsp; Execution Date: <b>${execDate}</b>${d.expiry?` &nbsp;Â·&nbsp; Offer Expires: <b>${fmtD(d.expiry)}</b>`:''}</div>
      </div>
      <div style="text-align:right;font-size:11px;opacity:.8"><div style="font-weight:700;font-size:13px">ContractAI Studio</div><div>2026 Edition</div>${isDraft?'<div style="margin-top:3px;background:rgba(255,255,255,.2);padding:2px 8px;border-radius:10px;font-weight:700;font-size:10px;letter-spacing:.5px">DRAFT</div>':''}</div>
    </div>
  </div>
  <div class="doc-bd">

    <h2>Parties to this Agreement</h2>
    <div class="parties">
      <div class="pbox"><strong>Freelancer (Service Provider)</strong><span><b>${d.flName}</b></span><span>${d.flAddr||''}</span><span>${d.flEmail||''}</span><span>${d.flPhone||''}</span>${d.flTin?`<span>TIN: ${d.flTin}</span>`:''  }${d.flOr?`<span>OR Series: ${d.flOr}</span>`:''}</div>
      <div class="pbox"><strong>Client</strong><span><b>${d.clName}</b></span>${d.clCompany?`<span>${d.clCompany}</span>`:''}${d.clAddr?`<span>${d.clAddr}</span>`:''}${d.clEmail?`<span>${d.clEmail}</span>`:''  }${d.clTin?`<span>TIN/BRN: ${d.clTin}</span>`:''}</div>
    </div>

    <div class="hbox">
      <div class="g2">
        <div class="gi"><span>Project</span><strong>${d.project||'â€”'}</strong></div>
        <div class="gi"><span>Category</span><strong>${d.category||'â€”'}</strong></div>
        <div class="gi"><span>Service Scope</span><strong>${d.scope||'â€”'}</strong></div>
        <div class="gi"><span>Payment Model</span><strong>${d.payModel||'â€”'}</strong></div>
        <div class="gi"><span>Payment Method</span><strong>${d.payMethod||'â€”'}</strong></div>
        <div class="gi"><span>Contract Period</span><strong>${fmtD(d.startDate)} â€“ ${fmtD(d.endDate)}</strong></div>
        <div class="gi"><span>Governing Law</span><strong>${d.govLaw||'Philippines'}</strong></div>
        <div class="gi"><span>Dispute Venue</span><strong>PDRC Â· Pasig City, PH</strong></div>
      </div>
    </div>

    <h2>Financial Summary</h2>
    <table><thead><tr><th>Item</th><th>Amount / Detail</th></tr></thead><tbody>
      <tr><td>Total Contract Value</td><td><b>${fmtM(rate,d.currency)}</b></td></tr>
      <tr><td>Deposit (${dep}% â€” non-refundable, due on signing)</td><td>${fmtM(depAmt,d.currency)}</td></tr>
      <tr><td>Remaining Balance</td><td>${fmtM(bal,d.currency)}</td></tr>
      <tr><td>Payment Method</td><td>${d.payMethod||'â€”'}</td></tr>
      <tr><td>Payment Due Period</td><td>${d.paydue||'7'} days from invoice</td></tr>
      <tr><td>Late Payment Fee</td><td>${d.latefee||'2'}% per month, compounded</td></tr>
      <tr><td>Included Revision Rounds</td><td>${d.revisions||'2'} rounds per milestone</td></tr>
    </tbody></table>

    ${msHTML}
    ${acHTML}
    ${clauseHTML}
    ${coHTML}
    ${exhibitHTML}

    <h2>Signatures & Execution</h2>
    <p style="font-size:12px">By signing below, both parties confirm they have read, understood, and agree to be legally bound by all terms of this Agreement effective as of the Execution Date stated above. This agreement is binding upon signature by both parties.</p>
    <p style="font-size:12px;margin-top:6px">Each party represents they have the legal authority to enter into this Agreement and that it has been executed voluntarily.</p>
    <div class="sg">
      <div><div class="sbox">${sigImg}<p><b>${d.flName}</b></p><p>Independent Contractor / Service Provider</p><p>Execution Date: ${execDate}</p>${d.flTin?`<p>TIN: ${d.flTin}</p>`:''}</div></div>
      <div><div class="sbox"><div style="height:48px;border-bottom:2px solid #1C1917;width:180px;margin-top:5px"></div><p><b>${d.clName}</b></p><p>${d.clCompany||'Client'}</p><p>Date: ___________________</p>${d.clTin?`<p>TIN: ${d.clTin}</p>`:''}</div></div>
    </div>
    <div style="margin-top:10px;font-size:11px;color:#78716C">
      <p><b>Received Copy Acknowledgment:</b> By signing above, each party acknowledges receiving a complete signed copy of this Agreement.</p>
    </div>
    ${witHTML}
    ${notHTML}

  </div>
  <div class="ft">
    ContractAI Studio 2026 &nbsp;Â·&nbsp; Contract No. ${d.cnum} &nbsp;Â·&nbsp; Version v${d.version||'1.0'}<br>
    Digital timestamp: ${new Date().toISOString()} UTC &nbsp;Â·&nbsp; Governed by the laws of ${d.govLaw||'Philippines'}<br>
    Both parties should retain a complete signed copy of this Agreement for their records.
  </div>
  </div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GENERATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function genContract(){
  const d=getForm();
  if(!validate(d))return;
  current={id:d.cnum,data:d,status:'Draft',createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),version:d.version};
  document.getElementById('preview-doc').innerHTML=buildHTML(d,'Draft');
  updWF('Draft');toast('Contract generated!','ok');nav('preview');
}
function saveDraft(){
  const d=getForm();
  if(!d.clName&&!d.project){toast('Enter client name or project name first','er');return;}
  const id=nextNum();d.cnum=id;
  contracts.push({id,data:d,status:'Draft',createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()});
  persist();toast('Draft saved Â· '+id,'ok');
}
function saveContract(){
  if(!current){toast('Generate a contract first','er');return;}
  const idx=contracts.findIndex(c=>c.id===current.id);
  if(idx>=0)contracts[idx]=current;else contracts.push(current);
  persist();toast('Saved Â· '+current.id,'ok');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATUS WORKFLOW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setStatus(s){
  if(!current){toast('Generate a contract first','er');return;}
  current.status=s;current.updatedAt=new Date().toISOString();
  document.getElementById('preview-doc').innerHTML=buildHTML(current.data,s);
  updWF(s);
  const idx=contracts.findIndex(c=>c.id===current.id);
  if(idx>=0){contracts[idx]=current;persist();}
  toast('Status: '+s,'ok');
}
function updWF(s){document.querySelectorAll('.wfb').forEach(b=>b.classList.toggle('on',b.textContent.trim()===s));}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PDF / PRINT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportPDF(){
  if(!current){toast('Generate a contract first','er');return;}
  try{
    const{jsPDF}=window.jspdf;
    const doc=new jsPDF({orientation:'portrait',unit:'mm',format:'a4'});
    const el=document.getElementById('preview-doc');
    doc.html(el,{callback:pdf=>{pdf.save(current.id+'.pdf');toast('PDF saved: '+current.id+'.pdf','ok');},x:8,y:8,width:194,windowWidth:900});
  }catch(e){toast('Saving as PDF via print dialog','in');window.print();}
}
function printDoc(){window.print();}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONTRACTS LOG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderLog(){
  const fs=document.getElementById('f-filter').value;
  const fq=(document.getElementById('f-search').value||'').toLowerCase();
  const list=[...contracts].reverse().filter(c=>{
    const ms=!fs||c.status===fs;
    const mq=!fq||(c.data.clName||'').toLowerCase().includes(fq)||(c.data.project||'').toLowerCase().includes(fq)||c.id.toLowerCase().includes(fq)||(c.data.category||'').toLowerCase().includes(fq);
    return ms&&mq;
  });
  document.getElementById('log-count').textContent=contracts.length+' contract'+(contracts.length!==1?'s':'')+' saved';
  const w=document.getElementById('log-list');
  if(!list.length){w.innerHTML='<p style="color:var(--ink4);font-size:13px;text-align:center;padding:28px">No contracts found.</p>';return;}
  const bm={Draft:'bd0',Sent:'bd1',Signed:'bd2',Active:'bd3',Completed:'bd4'};
  w.innerHTML=list.map(c=>`<div class="cr"><div class="cid">${c.id.split('-').pop()}</div><div class="cn"><h4>${c.data.clName||'â€”'}</h4><p>${c.data.project||'â€”'} Â· ${new Date(c.createdAt).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})}</p><p style="margin-top:2px">${c.data.category||''} Â· ${c.data.payModel||''} Â· ${c.data.payMethod||''}</p></div><div class="cra"><span class="badge ${bm[c.status]||'bd0'}">${c.status}</span><div style="display:flex;gap:4px"><button class="btn bxs bs" onclick="viewC('${c.id}')" title="View"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" width="12" height="12"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button><button class="btn bxs bg" onclick="editC('${c.id}')" title="Edit"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" width="12" height="12"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button><button class="btn bxs bg" onclick="dupC('${c.id}')" title="Duplicate"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" width="12" height="12"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg></button><button class="btn bxs bd" onclick="delC('${c.id}')" title="Delete"><svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" width="12" height="12"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/></svg></button></div></div></div>`).join('');
}
function viewC(id){const c=contracts.find(x=>x.id===id);if(!c)return;current=c;document.getElementById('preview-doc').innerHTML=buildHTML(c.data,c.status);updWF(c.status);nav('preview');}
function editC(id){
  const c=contracts.find(x=>x.id===id);if(!c)return;
  current=c;
  nav('create');
  setTimeout(()=>{setForm(c.data);toast('Contract loaded for editing','ok');},100);
}
function dupC(id){
  const c=contracts.find(x=>x.id===id);if(!c)return;
  const nid=nextNum(),copy=JSON.parse(JSON.stringify(c));
  copy.id=nid;copy.data.cnum=nid;copy.status='Draft';
  copy.createdAt=new Date().toISOString();copy.updatedAt=new Date().toISOString();
  contracts.push(copy);persist();renderLog();toast('Duplicated as '+nid,'ok');
}
function delC(id){
  if(!confirm('Delete '+id+'?'))return;
  contracts=contracts.filter(c=>c.id!==id);persist();renderLog();toast('Deleted','ok');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updDash(){
  document.getElementById('dash-date').textContent=new Date().toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
  document.getElementById('s-total').textContent=contracts.length;
  document.getElementById('s-draft').textContent=contracts.filter(c=>c.status==='Draft').length;
  document.getElementById('s-active').textContent=contracts.filter(c=>c.status==='Active'||c.status==='Signed').length;
  const cur=settings.currency||'PHP';
  const rev=contracts.reduce((a,c)=>a+(parseFloat(c.data.rate)||0),0);
  document.getElementById('s-rev').textContent=gSym(cur)+rev.toLocaleString('en-PH',{maximumFractionDigits:0});
  updRevChart();
  const recent=[...contracts].reverse().slice(0,5);
  const bm={Draft:'bd0',Sent:'bd1',Signed:'bd2',Active:'bd3',Completed:'bd4'};
  const w=document.getElementById('dash-recent');
  if(!recent.length){w.innerHTML='<p style="color:var(--ink4);font-size:13px;text-align:center;padding:16px 0">No contracts yet.</p>';return;}
  w.innerHTML=recent.map(c=>`<div style="display:flex;align-items:center;justify-content:space-between;padding:9px 0;border-bottom:1px solid var(--line);cursor:pointer" onclick="viewC('${c.id}')"><div><div style="font-weight:600;font-size:14px">${c.data.project||'Unnamed'}</div><div style="font-size:12px;color:var(--ink4)">${c.data.clName||'â€”'} Â· ${c.id}</div></div><span class="badge ${bm[c.status]||'bd0'}">${c.status}</span></div>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// REVENUE CHART
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updRevChart(){
  const el=document.getElementById('rev-chart');
  if(!el)return;
  if(!contracts.length){el.innerHTML='<p style="font-size:12px;color:var(--ink4);text-align:center;padding:16px 0">No contracts to chart.</p>';return;}
  const months={};
  contracts.forEach(c=>{
    const d=new Date(c.createdAt);
    const k=d.toLocaleDateString('en-US',{month:'short',year:'2-digit'});
    months[k]=(months[k]||0)+(parseFloat(c.data.rate)||0);
  });
  const keys=Object.keys(months).slice(-6);
  const vals=keys.map(k=>months[k]);
  const max=Math.max(...vals,1);
  const cur=settings.currency||'PHP';
  el.innerHTML=`<div class="bar-wrap">${keys.map((k,i)=>{const h=Math.max(4,Math.round((vals[i]/max)*80));return`<div class="bar-col"><div style="font-size:9px;color:var(--red);font-weight:700;height:14px;line-height:14px">${vals[i]>0?gSym(cur)+Math.round(vals[i]/1000)+'k':''}</div><div class="bar has" style="height:${h}px"></div><div class="bar-lbl">${k}</div></div>`}).join('')}</div>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PAYMENT CALC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function calcTotal(){
  const rate=parseFloat(document.getElementById('f-rate')?.value)||0;
  const dep=parseInt(document.getElementById('f-deposit')?.value)||0;
  const lf=parseFloat(document.getElementById('f-latefee')?.value)||2;
  const cur=document.getElementById('f-cur')?.value||'PHP';
  const fmt=n=>gSym(cur)+n.toLocaleString('en-PH',{minimumFractionDigits:2,maximumFractionDigits:2});
  document.getElementById('ps-tot').textContent=rate?fmt(rate):'â€”';
  document.getElementById('ps-dep').textContent=rate?fmt(rate*dep/100)+` (${dep}%)`:'â€”';
  document.getElementById('ps-bal').textContent=rate?fmt(rate-(rate*dep/100)):'â€”';
  document.getElementById('ps-lf').textContent=lf+'% / mo';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROGRESS DOTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updProg(){
  const secs=['sec-config','sec-fl','sec-cl','sec-pay','sec-clauses','sec-co','sec-sig'];
  const dots=document.querySelectorAll('.pd');
  secs.forEach((id,i)=>{
    const sec=document.getElementById(id);if(!sec||!dots[i])return;
    const inputs=sec.querySelectorAll('input:not([readonly]):not([type=file]):not([type=checkbox]),select');
    let filled=0;inputs.forEach(e=>{if(e.value.trim())filled++;});
    dots[i].classList.toggle('on',filled>0);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EMAIL / COPY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function emailC(){
  if(!current){toast('Generate a contract first','er');return;}
  const d=current.data;
  const s=encodeURIComponent(`Contract Agreement: ${d.project||'Project'} â€” ${d.cnum}`);
  const b=encodeURIComponent(`Dear ${d.clName||'Client'},\n\nPlease find attached the contract agreement for "${d.project}" (Contract No. ${d.cnum}, v${d.version||'1.0'}).\n\nSummary:\nâ€¢ Type: ${d.type}\nâ€¢ Category: ${d.category}\nâ€¢ Value: ${fmtM(d.rate,d.currency)} (${d.payModel})\nâ€¢ Payment Method: ${d.payMethod}\nâ€¢ Start: ${fmtD(d.startDate)}\nâ€¢ End: ${fmtD(d.endDate)}\nâ€¢ Deposit Required: ${fmtM(parseFloat(d.rate||0)*parseInt(d.deposit||50)/100,d.currency)}\n${d.expiry?`â€¢ Offer Expires: ${fmtD(d.expiry)}\n`:''}\nPlease review all terms and sign by the specified date.\n\nBest regards,\n${d.flName}\n${d.flEmail}\n${d.flPhone}`);
  window.open(`mailto:${d.clEmail||''}?subject=${s}&body=${b}`);toast('Email client opened','ok');
}
function copyTxt(){
  if(!current){toast('Generate a contract first','er');return;}
  const t=document.getElementById('preview-doc').innerText||'';
  if(navigator.clipboard){navigator.clipboard.writeText(t).then(()=>toast('Copied!','ok')).catch(()=>toast('Copy failed','er'));}
  else{const ta=document.createElement('textarea');ta.value=t;document.body.appendChild(ta);ta.select();document.execCommand('copy');document.body.removeChild(ta);toast('Copied!','ok');}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTOSAVE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let asTimer=null;
function trigAS(){
  const d=document.getElementById('asd');if(d)d.className='saving';
  clearTimeout(asTimer);
  asTimer=setTimeout(()=>{
    try{
      const snap={type:document.getElementById('f-type')?.value,payModel:document.getElementById('f-pay')?.value,currency:document.getElementById('f-cur')?.value,category:document.getElementById('f-cat')?.value,flName:document.getElementById('f-flname')?.value,clName:document.getElementById('f-clname')?.value,clEmail:document.getElementById('f-clemail')?.value,project:document.getElementById('f-proj')?.value,rate:document.getElementById('f-rate')?.value,startDate:document.getElementById('f-start')?.value,endDate:document.getElementById('f-end')?.value,execDate:document.getElementById('f-execdate')?.value,payMethod:document.getElementById('f-paymethod')?.value,savedAt:new Date().toISOString()};
      localStorage.setItem('cai_as',JSON.stringify(snap));
      if(d){d.className='saved';setTimeout(()=>{d.className='';},3000);}
    }catch(e){}
  },2000);
}
function restoreAS(){
  const sv=localStorage.getItem('cai_as');if(!sv)return;
  try{
    const d=JSON.parse(sv);
    if(!d.clName&&!d.project)return;
    const mins=Math.round((Date.now()-new Date(d.savedAt).getTime())/60000);
    if(mins>120)return;
    if(confirm(`Restore autosaved draft (${mins} min ago)?\nClient: ${d.clName||'â€”'} Â· Project: ${d.project||'â€”'}`)){
      const sv2=(id,v)=>{const e=document.getElementById(id);if(e&&v)e.value=v;};
      sv2('f-type',d.type);sv2('f-pay',d.payModel);sv2('f-cur',d.currency);sv2('f-cat',d.category);
      sv2('f-flname',d.flName);sv2('f-clname',d.clName);sv2('f-clemail',d.clEmail);
      sv2('f-proj',d.project);sv2('f-rate',d.rate);sv2('f-start',d.startDate);sv2('f-end',d.endDate);
      sv2('f-execdate',d.execDate);sv2('f-paymethod',d.payMethod);
      calcTotal();toast('Draft restored!','ok');
    }
  }catch(e){}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let darkOn=false,compactOn=false;
function togDark(){
  darkOn=!darkOn;
  const b=document.getElementById('tgl-dark');b.classList.toggle('on',darkOn);b.setAttribute('aria-checked',darkOn);
  const vars=darkOn?{'--w':'#1a1a1a','--line2':'#2a2a2a','--line':'#3a3a3a','--ink':'#F5F5F4','--ink2':'#D6D3D1','--ink3':'#A8A29E','--ink4':'#78716C','--pale':'#2a1210','--soft':'#3a1510'}:{'--w':'#FFFFFF','--line2':'#F5F5F4','--line':'#E7E5E4','--ink':'#1C1917','--ink2':'#44403C','--ink3':'#78716C','--ink4':'#A8A29E','--pale':'#FDF5F4','--soft':'#F9E8E6'};
  Object.entries(vars).forEach(([k,v])=>document.documentElement.style.setProperty(k,v));
  settings.dark=darkOn;saveS();
}
function togCompact(){
  compactOn=!compactOn;
  const b=document.getElementById('tgl-compact');b.classList.toggle('on',compactOn);b.setAttribute('aria-checked',compactOn);
  document.querySelectorAll('.card,.card-g,.card-r').forEach(el=>el.style.padding=compactOn?'12px':'18px');
  settings.compact=compactOn;saveS();
}
function saveSets(){
  settings.currency=document.getElementById('set-cur').value;
  settings.law=document.getElementById('set-law').value;
  settings.pm=document.getElementById('set-pm').value;
  saveS();
}
function saveS(){localStorage.setItem('cai_s',JSON.stringify(settings));}
function syncCur(){const c=document.getElementById('set-cur').value;const e=document.getElementById('f-cur');if(e)e.value=c;calcTotal();toast('Currency updated to '+c,'ok');}
function loadSets(){
  if(settings.dark)togDark();
  if(settings.compact)togCompact();
  if(settings.currency){const e=document.getElementById('set-cur');if(e)e.value=settings.currency;}
  if(settings.law){const e=document.getElementById('set-law');if(e)e.value=settings.law;}
  if(settings.pm){const e=document.getElementById('set-pm');if(e)e.value=settings.pm;}
}
function persist(){localStorage.setItem('cai_c',JSON.stringify(contracts));}
function exportData(){const b=new Blob([JSON.stringify(contracts,null,2)],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='contractai-'+Date.now()+'.json';a.click();URL.revokeObjectURL(a.href);toast('Exported '+contracts.length+' contracts','ok');}
function importData(inp){if(!inp.files[0])return;const fr=new FileReader();fr.onload=e=>{try{const data=JSON.parse(e.target.result);if(!Array.isArray(data))throw 0;contracts=[...contracts,...data.filter(c=>!contracts.find(x=>x.id===c.id))];persist();renderLog();updDash();toast('Imported '+data.length+' contracts','ok');}catch{toast('Invalid file','er');}};fr.readAsText(inp.files[0]);}
function resetAll(){if(!confirm('Delete ALL data? Cannot be undone.'))return;contracts=[];settings={};sigData=null;milestones=[];acceptCrit=[];changeOrders=[];['cai_c','cai_s','cai_sig','cai_seq','cai_as'].forEach(k=>localStorage.removeItem(k));renderLog();updDash();toast('All data cleared','ok');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toast(msg,type='ok'){
  const el=document.createElement('div');
  el.style.cssText='background:var(--ink);color:var(--w);padding:10px 15px;border-radius:6px;font-size:14px;font-weight:500;box-shadow:0 8px 24px rgba(0,0,0,.22);animation:pgin .25s ease;display:flex;align-items:center;gap:9px;border-left:4px solid '+(type==='ok'?'#22C55E':type==='er'?'#EF4444':'var(--red)');
  el.innerHTML=`<span>${{ok:'âœ“',er:'âœ•',in:'â„¹'}[type]||'â„¹'}</span><span>${msg}</span>`;
  document.getElementById('toast').appendChild(el);
  setTimeout(()=>el.remove(),3200);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('load',()=>{
  initClauses();
  initCanvas();
  renderMS();renderAC();renderCO();
  loadSets();
  updDash();

  // Set contract number
  document.getElementById('f-cnum').value=nextNum();

  // Default dates
  const today=new Date();
  document.getElementById('f-start').value=today.toISOString().split('T')[0];
  document.getElementById('f-execdate').value=today.toISOString().split('T')[0];
  const end=new Date(today);end.setMonth(end.getMonth()+1);
  document.getElementById('f-end').value=end.toISOString().split('T')[0];
  const expiry=new Date(today);expiry.setDate(expiry.getDate()+30);
  document.getElementById('f-expiry').value=expiry.toISOString().split('T')[0];

  // Restore sig
  if(sigData){
    document.getElementById('sig-note').style.display='block';
    const img=new Image();img.onload=()=>{const c=document.getElementById('sig-canvas');c.getContext('2d').drawImage(img,0,0,c.width,c.height);};img.src=sigData;
  }

  // Listeners
  const pg=document.getElementById('pg-create');
  pg.addEventListener('input',()=>{trigAS();updProg();});
  pg.addEventListener('change',()=>{trigAS();updProg();});
  updProg();calcTotal();

  // Autosave restore
  setTimeout(restoreAS,900);
});
</script>
</body>
</html>
